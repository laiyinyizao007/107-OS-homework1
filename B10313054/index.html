<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        HW1 - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i|Source+Code+Pro:300,400,500|Source+Sans+Pro:300,300i,400,400i,600,600i|Source+Serif+Pro&subset=latin-ext);.hljs{display:block;background:#fff;padding:.5em;color:#333;overflow-x:auto}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-string,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#a71d5d}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#0086b3}.hljs-built_in,.hljs-builtin-name{color:#005cc5}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#795da3}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{font-size:16px;padding:0 1em;color:#777;border-left:.25em solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#000;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:0;padding-top:.2em;padding-bottom:.2em;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\00a0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid #ccc;border-bottom-color:#bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0 none}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif;padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important}.markdown-body .emoji{vertical-align:top}.markdown-body pre{border:inherit!important}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.markdown-body code[data-gist-id]{background:none;padding:0}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram{text-align:center;background-color:inherit;border-radius:0;white-space:inherit}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg{max-width:100%;height:100%}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.markdown-body summary{display:list-item}.markdown-body summary:focus{outline:none}.markdown-body details summary{cursor:pointer}.markdown-body details:not([open])>:not(summary){display:none}.markdown-body figure{margin:1em 40px}.markdown-body .mark,.markdown-body mark{background-color:#fff1a7}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.MJX_Assistive_MathML{display:none}.ui-infobar{position:relative;z-index:2;max-width:758px;margin-top:25px;margin-bottom:-25px;color:#777}.ui-toc{position:fixed;bottom:20px;z-index:10000}.ui-toc-label{opacity:.3;background-color:#ccc;border:none;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#fff;transition:opacity .2s}.ui-toc-label:focus{opacity:.3;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;transition:opacity .2s}.ui-toc-dropdown{margin-top:23px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child > ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ\ ゴシック,sans-serif}.ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,ＭＳ\ Ｐゴシック,sans-serif}.markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}.ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,微軟正黑UI,sans-serif}.markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}.ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,微软雅黑UI,sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:#999}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:contain}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}.ui-infobar>small>span{line-height:22px}.ui-infobar>small .dropdown{display:inline-block}.ui-infobar>small .dropdown a:focus,.ui-infobar>small .dropdown a:hover{text-decoration:none}.unselectable{-webkit-user-select:none;-o-user-select:none;user-select:none}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}.focus,:focus{outline:none!important}::-moz-focus-inner{border:0!important}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid" style="position: relative;"><h1 id="HW1"><a class="anchor hidden-xs" href="#HW1" title="HW1"><span class="octicon octicon-link"></span></a>HW1</h1><h2 id="項目一："><a class="anchor hidden-xs" href="#項目一：" title="項目一："><span class="octicon octicon-link"></span></a>項目一：</h2><p><img src="https://i.imgur.com/n3XK0Ka.png" alt=""></p><h3 id="此時暫存器的值"><a class="anchor hidden-xs" href="#此時暫存器的值" title="此時暫存器的值"><span class="octicon octicon-link"></span></a>此時暫存器的值</h3><p>（首碼e表示他們是以下16位寄存器的32位擴展，是別名）</p><h4 id="通用寄存器："><a class="anchor hidden-xs" href="#通用寄存器：" title="通用寄存器："><span class="octicon octicon-link"></span></a>通用寄存器：</h4><p>AX (Accumulator)：累加寄存器，也稱之為累加器：eax：0×aa55<br>
BX (Base)：基底位址寄存器：ebx：0×0<br>
CX (Count)：計數器寄存器：ecx：0×0<br>
DX (Data)：資料寄存器：edx：0×80</p><h4 id="指針寄存器："><a class="anchor hidden-xs" href="#指針寄存器：" title="指針寄存器："><span class="octicon octicon-link"></span></a>指針寄存器：</h4><p>SP (Stack Pointer)：堆疊指標寄存器：esp：0×6f2c<br>
BP (Base Pointer)：基指針寄存器：ebp：0×0</p><h4 id="變址寄存器："><a class="anchor hidden-xs" href="#變址寄存器：" title="變址寄存器："><span class="octicon octicon-link"></span></a>變址寄存器：</h4><p>SI (Source Index)：源變址寄存器：esi：0×0<br>
DI (Destination Index)：edi：目的變址寄存器：0×0<br>
控制寄存器：<br>
IP (Instruction Pointer)：指令指標寄存器：eip：0×7c00<br>
FLAG：標誌寄存器：eflags：0×202</p><h4 id="段寄存器："><a class="anchor hidden-xs" href="#段寄存器：" title="段寄存器："><span class="octicon octicon-link"></span></a>段寄存器：</h4><p>CS (Code Segment)：程式碼片段寄存器：0×0<br>
SS (Stack Segment)：堆疊段寄存器：0×0<br>
DS (Data Segment)：資料段寄存器：0×0<br>
ES (Extra Segment)：附加段寄存器：0×0<br>
FS (Extra Segment)：附加段寄存器：0×0<br>
GS (Extra Segment)：附加段寄存器：0×0</p><h3 id="STACK"><a class="anchor hidden-xs" href="#STACK" title="STACK"><span class="octicon octicon-link"></span></a>STACK</h3><ul>
<li>從esp開始，列出24個字，以16進制顯示, （esp寄存器存放堆疊段棧頂的位置，如果往堆疊中push了，那麼esp中的值會變小，32位機中esp一次移動4byte）<br>
0x6f2c: 0xf000d242 0x00000000 0x00006f6a 0x00000000<br>
0x6f3c: 0x0000916e 0x00009135 0x00000000 0x00000000<br>
0x6f4c: 0x00006c65 0x00007c00 0x00000080 0x000f1ede<br>
0x6f5c: 0x000f3e37 0x00000000 0x00007c00 0x00000001<br>
0x6f6c: 0x00000000 0x00000000 0x00000000 0x00000000<br>
0x6f7c: 0x00800000 0x00000000 0xaa550000 0x7c000000</li>
<li>esp在bootloader運行的時候被設置為0x7c00，0x7c00之前是bootloader的stack。 0x7c00之後是bootloader的代碼，0x7c00-0x7c43存放的是bootmain.S中的指令。在0x7c43處初始化堆疊<br>
<img src="https://i.imgur.com/4Ml9R5f.png" alt=""><br>
0x6f88: 0x7c000000//%esp函數的返回地址<br>
0x6f84: 0xaa550000 //%eax寄存器的內容<br>
0x6f80: 0x00000000//%eax<br>
<img src="https://i.imgur.com/aQedWaj.png" alt=""><br>
0x6f7c: 0x00800000 //%edx寄存器的內容<br>
0x6f68：0x00000001 //%cr0<br>
0x6f64：0x00007c00 //%esp<br>
0x6f54：0x00000080 //%edx寄存器的內容<br>
0x6f50：0x00007c00//%esp</li>
</ul><h2 id="項目二："><a class="anchor hidden-xs" href="#項目二：" title="項目二："><span class="octicon octicon-link"></span></a>項目二：</h2><h3 id="第0章"><a class="anchor hidden-xs" href="#第0章" title="第0章"><span class="octicon octicon-link"></span></a>第0章</h3><h4 id="作業系統介面"><a class="anchor hidden-xs" href="#作業系統介面" title="作業系統介面"><span class="octicon octicon-link"></span></a>作業系統介面</h4><ul>
<li>作業系統通過介面（系統調用）實現資源分享，底層抽象，多工，程式交互。設計者通過少量機制（mechanism）的組合提供強大通用的功能。<br>
<img src="https://i.imgur.com/rm5Tmdj.png" alt=""></li>
<li>程式含指令，資料，棧的記憶體空間，運行中的程式稱為進程，Xv6的進程有pid關聯，由使用者記憶體空間（指令，資料，棧）和狀態組成。Xv6可以在CPU間切換，決定進程的狀態，並且保存他們的寄存器，以期將來恢復執行。</li>
<li>shell是一個不在內核的可替代的普通程式和使用者介面。而內核是一個為其他程式提供服務的特殊程式。進程只能訪問自己的記憶體空間，可以通過系統調用進入內核空間，讓擁有硬體許可權（hardware privileges）的內核提升特權級來執行服務然後返回使用者空間。</li>
</ul><h4 id="系統調用描述"><a class="anchor hidden-xs" href="#系統調用描述" title="系統調用描述"><span class="octicon octicon-link"></span></a>系統調用描述</h4><table>
<thead>
<tr>
<th>系統調用</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>fork()</td>
<td>創建進程</td>
</tr>
<tr>
<td>Text</td>
<td>Text</td>
</tr>
<tr>
<td>exit()</td>
<td>結束當前進程</td>
</tr>
<tr>
<td>wait()</td>
<td>等待子進程結束</td>
</tr>
<tr>
<td>kill(pid)</td>
<td>結束 pid 所指進程</td>
</tr>
<tr>
<td>getpid()</td>
<td>獲得當前進程 pid</td>
</tr>
<tr>
<td>sleep(n)</td>
<td>睡眠 n 秒</td>
</tr>
<tr>
<td>exec(filename, argv)</td>
<td>載入並執行一個檔</td>
</tr>
<tr>
<td>sbrk(n)</td>
<td>為進程記憶體空間增加 n 位元組</td>
</tr>
<tr>
<td>open(filename, flags)</td>
<td>打開檔，</td>
</tr>
<tr>
<td>read(fd, buf, n)</td>
<td>從檔中讀 n 個位元組到 buf</td>
</tr>
<tr>
<td>write(fd, buf, n)</td>
<td>從 buf 中寫 n 個位元組到檔</td>
</tr>
<tr>
<td>close(fd)</td>
<td>關閉打開的 fd</td>
</tr>
<tr>
<td>dup(fd)</td>
<td>複製 fd</td>
</tr>
<tr>
<td>pipe( p)</td>
<td>創建管道， 並把讀和寫的 fd 返回到p</td>
</tr>
<tr>
<td>chdir(dirname)</td>
<td>改變目前的目錄</td>
</tr>
<tr>
<td>mkdir(dirname)</td>
<td>創建新的目錄</td>
</tr>
<tr>
<td>mknod(name, major, minor)</td>
<td>創建設備檔</td>
</tr>
<tr>
<td>fstat(fd)</td>
<td>返回檔資訊</td>
</tr>
<tr>
<td>link(f1, f2)</td>
<td>給 f1 創建一個新名字(f2)</td>
</tr>
<tr>
<td>unlink(filename)</td>
<td>刪除檔*</td>
</tr>
</tbody>
</table><h4 id="進程和記憶體"><a class="anchor hidden-xs" href="#進程和記憶體" title="進程和記憶體"><span class="octicon octicon-link"></span></a>進程和記憶體</h4><ul>
<li>Xv6 shell為使用者執行程式時，主迴圈通過getcmd讀取命令列的輸入，調用fork生成一個shell進程的副本並為其隱式地分配空間來創建進程，父進程返回子進程的pid，子進程返回0。在fork中，父shell調用wait等著直到有一個子進程返回，同時子進程由getcmd以輸入為參數調用runcmd，runcmd又以可執行檔名和一個字串參數組調用系統調用exec。exec會隱式地為可執行檔分配空間，從ELF格式的檔中讀取記憶體鏡像到進程的記憶體空間，然後執行載入的指令，還可以用sbrk（n）來增加額外記憶體。最後某個時刻系統調用exit會導致進程停止運行並釋放資源，父進程從wait返回。</li>
</ul><h4 id="IO和檔描述符"><a class="anchor hidden-xs" href="#IO和檔描述符" title="IO和檔描述符"><span class="octicon octicon-link"></span></a>I/O和檔描述符</h4><ul>
<li>檔描述符（file descriptor）是對檔的抽象，它的介面是對檔，管道，設備等的抽象。每個進程都有一個它的檔描述符，因為通過檔描述符可以索引到進程的表。內核為每個進程維護了一個從0開始的private空間存放檔描述符表，這個表以FD為索引，再進一步指向檔的詳細資訊。慣例是檔描述符0讀入，1輸出，2錯誤，操作的物件可以是檔/設備/管道。</li>
<li>read（fd，buf，n）從fd（文件描述符）讀最多n個位元組，拷貝到buf中，然後返回讀出的位元組數。每個檔描述符都有一個offset，read會從當前的offset處讀取資料，給offset加上上文提到的返回的位元組數，之後再用read就會從新的offset處讀取。當沒有資料可讀時，read就返回0。</li>
<li>write（fd，buf，n）寫buf中的n個位元組到fd並返回實際寫出的位元組數。也是在offset處寫並增加offset。</li>
<li>實現I/O的重定向，shell fork得到一個父進程的克隆子進程，子進程中的runcmd會調用exec載入指令，但是保留了檔描述符表，子進程close檔描述符0後0可以被重用，重新open會用當前最小的0作為新打開的檔的檔描述符，因此之後標準輸入就會指向新打開的檔。</li>
<li>從同一個檔描述符通過fork和dup產生的檔描述符都共用offset，可以按順序輸出。父子進程因此可以按shell命令的順序輸出。Dup複製一個已有的檔描述符並和它共用offset，所以也可以按順序輸出。</li>
</ul><h4 id="管道（pipes）"><a class="anchor hidden-xs" href="#管道（pipes）" title="管道（pipes）"><span class="octicon octicon-link"></span></a>管道（pipes）</h4><ul>
<li>管道是檔描述符形式的內核緩衝區，一端是寫，另一端是讀。它可以自我清掃，傳輸任意長度的資料，允許通過一對管道來同步兩個進程。應用的時候就是創建一個陣列來記錄管道的檔描述符。</li>
</ul><h4 id="檔案系統"><a class="anchor hidden-xs" href="#檔案系統" title="檔案系統"><span class="octicon octicon-link"></span></a>檔案系統</h4><ul>
<li>檔案系統由檔和目錄組成，目錄是其他目錄或檔的reference，每一個檔都有唯一的inode number，當連接數變成0時檔的磁碟空間會清空。</li>
<li>chdir可以改變目前的目錄，mkdir創建目錄，open+O_CREATE可以打開一個新的檔，mknod創建一個新的設備檔，fstat可以獲取一個檔描述符指向的檔的資訊，link可以為檔創建另一個名稱（別名），unlink則移除一個別名（用來創建臨時inode）。</li>
</ul><h3 id="第1章"><a class="anchor hidden-xs" href="#第1章" title="第1章"><span class="octicon octicon-link"></span></a>第1章</h3><h4 id="第一個進程"><a class="anchor hidden-xs" href="#第一個進程" title="第一個進程"><span class="octicon octicon-link"></span></a>第一個進程</h4><p>本章介紹第一個進程的創建來解釋xv6是如何開始運行的。</p><h4 id="進程概覽"><a class="anchor hidden-xs" href="#進程概覽" title="進程概覽"><span class="octicon octicon-link"></span></a>進程概覽</h4><ul>
<li>進程通過提供一部分獨佔的記憶體系統，和看上去僅執行該程式的CPU，讓程式以為它獨佔一台機器。每個進程都有不同4的頁表（page table），頁表定義進程的位址空間，將虛擬位址翻譯為物理位址。進程的狀態由struct proc維護。進程由一個執行緒來執行進程的指令，可以被掛起稍後再恢復，在用戶棧運行用戶代碼，在內核棧（p-&gt;kstack）運行內核代碼。P-&gt;state 指示了進程的狀態，P-&gt;pgdir保存進程的頁表。</li>
<li>當進程使用系統調用時，處理器轉入內核棧中，提升硬體的特權級，然後對應的內核的指令和資料會被進程映射到每個進程的位址空間中的內核棧執行。當系統調用完成時，又降低硬體特權級，轉入使用者棧，恢復執行系統調用指令後面的那條指令。<br>
<img src="https://i.imgur.com/vAJVx1K.png" alt=""></li>
</ul><h4 id="代碼：第一個位址空間"><a class="anchor hidden-xs" href="#代碼：第一個位址空間" title="代碼：第一個位址空間"><span class="octicon octicon-link"></span></a>代碼：第一個位址空間</h4><ul>
<li>當PC開機時，它會初始化自己，然後從磁片中載入boot loader到記憶體並運行，然後bootloader把內核從磁片中載入到物理位址0100000並從entry（1040）開始運行，entry設置了頁表，將080000000開始的虛擬位址映射到物理位址00處。最後entry跳轉到高位址的main代碼中。</li>
</ul><h4 id="代碼：創建第一個進程"><a class="anchor hidden-xs" href="#代碼：創建第一個進程" title="代碼：創建第一個進程"><span class="octicon octicon-link"></span></a>代碼：創建第一個進程</h4><ul>
<li>main初始化一些設備和子系統後，調用userinit建立第一個進程。userinit調用allocproc在頁表中分配struct proc，並初始化進程的狀態。初始完把p-&gt;state設置為RUNNABLE，使進程能夠被調度。</li>
</ul><h4 id="運行第一個進程"><a class="anchor hidden-xs" href="#運行第一個進程" title="運行第一個進程"><span class="octicon octicon-link"></span></a>運行第一個進程</h4><ul>
<li>mpmain調用scheduler開始運行進程。scheduler會找到一個p-&gt;state為RUNNABLE的進程initproc，，然後將per-cpu的標量proc為該進程，接著調用switchuvm通知硬體開始使用目標進程的頁表。然後把進程的p—&gt;state設置為RUNNING，調用swtch，切換context到目標進程的內核執行緒中。</li>
</ul><h4 id="第一個系統調用exec"><a class="anchor hidden-xs" href="#第一個系統調用exec" title="第一個系統調用exec"><span class="octicon octicon-link"></span></a>第一個系統調用exec</h4><ul>
<li>Initcode.S先觸發系統調用exec，執行從檔案系統中獲取的/init來建立系統。</li>
</ul><h2 id="項目三："><a class="anchor hidden-xs" href="#項目三：" title="項目三："><span class="octicon octicon-link"></span></a>項目三：</h2><p>第六章 檔案系統Sourcecode範圍：<br>
file.h/File.c/Fs.c/Bio.c/Ide.c</p><h3 id="概述"><a class="anchor hidden-xs" href="#概述" title="概述"><span class="octicon octicon-link"></span></a>概述</h3><p>檔案系統用來組織和存儲資料，主要的目的是支援資料共用和持久化。Xv6的檔案系統分6層實現。<br>
<img src="https://i.imgur.com/DNO0Cpa.png" alt=""></p><h3 id="Buffer-cache"><a class="anchor hidden-xs" href="#Buffer-cache" title="Buffer-cache"><span class="octicon octicon-link"></span></a>Buffer cache</h3><h4 id="資料結構bioc"><a class="anchor hidden-xs" href="#資料結構bioc" title="資料結構bioc"><span class="octicon octicon-link"></span></a>資料結構(bio.c)</h4><pre><code class="javascript hljs"><span class="token number">3850</span> struct buf <span class="token punctuation">{</span>
<span class="token number">3851</span> int flags<span class="token punctuation">;</span>  <span class="token comment">//緩衝區狀態</span>
<span class="token number">3852</span> uint dev<span class="token punctuation">;</span>  <span class="token comment">//設備號</span>
<span class="token number">3853</span> uint blockno<span class="token punctuation">;</span>  <span class="token comment">//塊編號</span>
<span class="token number">3854</span> struct sleeplock lock<span class="token punctuation">;</span>
<span class="token number">3855</span> uint refcnt<span class="token punctuation">;</span>
<span class="token number">3856</span> struct buf <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment">// LRU cache list鏈表指向前一個節點</span>
<span class="token number">3857</span> struct buf <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token comment">//鏈表指向下一個節點</span>
<span class="token number">3858</span> struct buf <span class="token operator">*</span>qnext<span class="token punctuation">;</span> <span class="token comment">// disk queue</span>
<span class="token number">3859</span> uchar data<span class="token punctuation">[</span><span class="token constant">BSIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">3860</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">3861</span> #define <span class="token constant">B_VALID</span> <span class="token number">0x2</span> <span class="token comment">// buffer has been read from disk</span>
<span class="token number">3862</span> #define <span class="token constant">B_DIRTY</span> <span class="token number">0x4</span> <span class="token comment">// buffer needs to be written to disk</span>
</code></pre><h4 id="運作原理0"><a class="anchor hidden-xs" href="#運作原理0" title="運作原理0"><span class="octicon octicon-link"></span></a>運作原理:</h4><p>最下面一層通過塊緩衝讀寫IDE硬碟，塊緩衝是緩衝區的雙向鏈表。它用來同步對磁片的訪問和緩存常用的塊。主要介面是 bread 和 bwrite。當內核處理完一個緩衝塊之後，需要調用 brelse 釋放它。塊緩衝有固定數量的緩衝區，這裡的置換策略是 LRU。<br>
xv6在內核中分配了靜態陣列然後binit會從陣列 buf 中構建出一個有 NBUF 個元素的雙向鏈表。所有對塊緩衝的訪問都通過鏈表。</p><pre><code class="javascript hljs"><span class="token number">4428</span> struct <span class="token punctuation">{</span>
<span class="token number">4429</span> struct spinlock lock<span class="token punctuation">;</span>
<span class="token number">4430</span> struct buf buf<span class="token punctuation">[</span><span class="token constant">NBUF</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//有NBUF個元素的雙向鏈表</span>
<span class="token number">4431</span>
<span class="token number">4432</span> <span class="token comment">// Linked list of all buffers, through prev/next.</span>
<span class="token number">4433</span> <span class="token comment">// head.next is most recently used.</span>
<span class="token number">4434</span> struct buf head<span class="token punctuation">;</span>
<span class="token number">4435</span> <span class="token punctuation">}</span> bcache<span class="token punctuation">;</span> <span class="token comment">//自旋鎖，保證一致性</span>
</code></pre><ul>
<li>binit初始化bcache結構並設置塊緩衝區需要使用的鎖。</li>
</ul><pre><code class="javascript hljs"><span class="token number">4437</span>	<span class="token keyword">void</span>
<span class="token number">4438</span>	<span class="token function">binit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">4439</span>	<span class="token punctuation">{</span>
<span class="token number">4440</span>	struct buf <span class="token operator">*</span>b<span class="token punctuation">;</span>
<span class="token number">4441</span>	
<span class="token number">4442</span>	<span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"bcache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">4450</span>	<span class="token comment">// Create linked list of buffers</span>
<span class="token number">4451</span>	bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
<span class="token number">4452</span>	bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
<span class="token number">4453</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buf<span class="token punctuation">;</span> b <span class="token operator">&lt;</span> bcache<span class="token punctuation">.</span>buf<span class="token operator">+</span><span class="token constant">NBUF</span><span class="token punctuation">;</span> b<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4454</span>	b−<span class="token operator">&gt;</span>next <span class="token operator">=</span> bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token number">4455</span>	b−<span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
<span class="token number">4456</span>	<span class="token function">initsleeplock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b−<span class="token operator">&gt;</span>lock<span class="token punctuation">,</span> <span class="token string">"buffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4457</span>	bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next−<span class="token operator">&gt;</span>prev <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token number">4458</span>	bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token number">4459</span>	<span class="token punctuation">}</span>
<span class="token number">4460</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>bread根據參數確定設備號和塊編號並調用bget得到塊緩衝結構，bget遍歷塊緩衝區中找到緩衝塊，如果有一個buffer空閒，bget設置其B_BUSY標誌位元然後返回，如果此緩衝塊已經有進程佔用，則睡眠當前進程等待喚醒。如果bget沒有找到相應的塊緩衝結構，則在緩衝區中找到一個失效的塊緩衝區並返回，由bread調用iderw來將資料讀入內核。如果緩衝區滿，全都busy，bget就報錯。</li>
</ul><pre><code class="javascript hljs"><span class="token number">4462</span>	<span class="token comment">// Look through buffer cache for block on device dev.</span>
<span class="token number">4463</span>	<span class="token comment">// If not found, allocate a buffer.</span>
<span class="token number">4464</span>	<span class="token comment">// In either case, return locked buffer.</span>
<span class="token number">4465</span>	<span class="token keyword">static</span> struct buf<span class="token operator">*</span><span class="token comment">//建立固定數量的buf</span>
<span class="token number">4466</span>	<span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span> <span class="token comment">//根據給定的設備和磁區號來掃描鏈表</span>
<span class="token number">4467</span>	<span class="token punctuation">{</span>
<span class="token number">4468</span>	struct buf <span class="token operator">*</span>b<span class="token punctuation">;</span>
<span class="token number">4469</span>	
<span class="token number">4470</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4471</span>	
<span class="token number">4472</span>	<span class="token comment">// Is the block already cached?</span>
<span class="token number">4473</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>head<span class="token punctuation">;</span> b <span class="token operator">=</span> b−<span class="token operator">&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4474</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>b−<span class="token operator">&gt;</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b−<span class="token operator">&gt;</span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4475</span>	b−<span class="token operator">&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">4476</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4477</span>	<span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4478</span>	<span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token number">4479</span>	<span class="token punctuation">}</span>
<span class="token number">4480</span>	<span class="token punctuation">}</span>
<span class="token number">4481</span>	
<span class="token number">4482</span>	<span class="token comment">// Not cached; recycle an unused buffer.</span>
<span class="token number">4483</span>	<span class="token comment">// Even if refcnt==0, B_DIRTY indicates a buffer is in use</span>
<span class="token number">4484</span>	<span class="token comment">// because log.c has modified it but not yet committed it.</span>
<span class="token number">4485</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>prev<span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>head<span class="token punctuation">;</span> b <span class="token operator">=</span> b−<span class="token operator">&gt;</span>prev<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4486</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>b−<span class="token operator">&gt;</span>refcnt <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>b−<span class="token operator">&gt;</span>flags <span class="token operator">&amp;</span> <span class="token constant">B_DIRTY</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">4487</span>	b−<span class="token operator">&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
<span class="token number">4488</span>	b−<span class="token operator">&gt;</span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>
<span class="token number">4489</span>	b−<span class="token operator">&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">4490</span>	b−<span class="token operator">&gt;</span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">4491</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4492</span>	<span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4493</span>	<span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token number">4494</span>	<span class="token punctuation">}</span>
<span class="token number">4495</span>	<span class="token punctuation">}</span>
<span class="token number">4496</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bget: no buffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4497</span>	<span class="token punctuation">}</span>
<span class="token number">4498</span>	
<span class="token number">4499</span>
<span class="token number">4500</span>	<span class="token comment">// Return a locked buf with the contents of the indicated block.</span>
<span class="token number">4501</span>	struct buf<span class="token operator">*</span>
<span class="token number">4502</span>	<span class="token function">bread</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span>
<span class="token number">4503</span>	<span class="token punctuation">{</span>
<span class="token number">4504</span>	struct buf <span class="token operator">*</span>b<span class="token punctuation">;</span>
<span class="token number">4505</span>	
<span class="token number">4506</span>	b <span class="token operator">=</span> <span class="token function">bget</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> blockno<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//調用bget函數獲得給定的buffer</span>
<span class="token number">4507</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b−<span class="token operator">&gt;</span>flags <span class="token operator">&amp;</span> <span class="token constant">B_VALID</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//若該buffer的狀態不是valid</span>
<span class="token number">4508</span>	<span class="token function">iderw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//調用iderw來讀取</span>
<span class="token number">4509</span>	<span class="token punctuation">}</span>
<span class="token number">4510</span>	<span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token number">4511</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>bwrite將塊緩衝結構寫入磁片</li>
</ul><pre><code class="javascript hljs"><span class="token number">4513</span>	<span class="token comment">// Write b’s contents to disk. Must be locked.</span>
<span class="token number">4514</span>	<span class="token keyword">void</span>
<span class="token number">4515</span>	<span class="token function">bwrite</span><span class="token punctuation">(</span>struct buf <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token number">4516</span>	<span class="token punctuation">{</span>
<span class="token number">4517</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4518</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bwrite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4519</span>	b−<span class="token operator">&gt;</span>flags <span class="token operator">|=</span> <span class="token constant">B_DIRTY</span><span class="token punctuation">;</span>
<span class="token number">4520</span>	<span class="token function">iderw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4521</span>	<span class="token punctuation">}</span>
brelse則減少塊的引用次數，並移動塊的位置實現<span class="token constant">LRU</span>
<span class="token number">4523</span>	<span class="token comment">// Release a locked buffer.</span>
<span class="token number">4524</span>	<span class="token comment">// Move to the head of the MRU list.</span>
<span class="token number">4525</span>	<span class="token keyword">void</span>
<span class="token number">4526</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>struct buf <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token number">4527</span>	<span class="token punctuation">{</span>
<span class="token number">4528</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4529</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"brelse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4530</span>	
<span class="token number">4531</span>	<span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4532</span>	
<span class="token number">4533</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4534</span>	b−<span class="token operator">&gt;</span>refcnt−−<span class="token punctuation">;</span>
<span class="token number">4535</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span>b−<span class="token operator">&gt;</span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">4536</span>	<span class="token comment">// no one is waiting for it.</span>
<span class="token number">4537</span>	b−<span class="token operator">&gt;</span>next−<span class="token operator">&gt;</span>prev <span class="token operator">=</span> b−<span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
<span class="token number">4538</span>	b−<span class="token operator">&gt;</span>prev−<span class="token operator">&gt;</span>next <span class="token operator">=</span> b−<span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
<span class="token number">4539</span>	b−<span class="token operator">&gt;</span>next <span class="token operator">=</span> bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token number">4540</span>	b−<span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
<span class="token number">4541</span>	bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next−<span class="token operator">&gt;</span>prev <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token number">4542</span>	bcache<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token number">4543</span>	<span class="token punctuation">}</span>
<span class="token number">4544</span>	
<span class="token number">4545</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4546</span>	<span class="token punctuation">}</span>
</code></pre><h4 id="程式流程0"><a class="anchor hidden-xs" href="#程式流程0" title="程式流程0"><span class="octicon octicon-link"></span></a>程式流程</h4><p><img src="https://i.imgur.com/z02V47j.png" alt=""></p><h3 id="Logging"><a class="anchor hidden-xs" href="#Logging" title="Logging"><span class="octicon octicon-link"></span></a>Logging</h3><h4 id="資料結構（logc）"><a class="anchor hidden-xs" href="#資料結構（logc）" title="資料結構（logc）"><span class="octicon octicon-link"></span></a>資料結構（log.c）</h4><pre><code class="javascript hljs"><span class="token number">4731</span>	<span class="token comment">// Contents of the header block, used for both the on−disk header block</span>
<span class="token number">4732</span>	<span class="token comment">// and to keep track in memory of logged block# before commit.</span>
<span class="token number">4733</span>	struct logheader <span class="token punctuation">{</span>
<span class="token number">4734</span>	int n<span class="token punctuation">;</span><span class="token comment">//起始塊的計數</span>
<span class="token number">4735</span>	int block<span class="token punctuation">[</span><span class="token constant">LOGSIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//起始塊</span>
<span class="token number">4736</span>	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">4737</span>	
<span class="token number">4738</span>	struct log <span class="token punctuation">{</span>
<span class="token number">4739</span>	struct spinlock lock<span class="token punctuation">;</span><span class="token comment">//鎖</span>
<span class="token number">4740</span>	int start<span class="token punctuation">;</span>
<span class="token number">4741</span>	int size<span class="token punctuation">;</span><span class="token comment">//日誌大小</span>
<span class="token number">4742</span>	int outstanding<span class="token punctuation">;</span> <span class="token comment">// how many FS sys calls are executing.</span>
<span class="token number">4743</span>	int committing<span class="token punctuation">;</span> <span class="token comment">// in commit(), please wait.</span>
<span class="token number">4744</span>	int dev<span class="token punctuation">;</span> <span class="token comment">//設備號</span>
<span class="token number">4745</span>	struct logheader lh<span class="token punctuation">;</span><span class="token comment">//起始塊</span>
<span class="token number">4746</span>	<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h4 id="運作原理0"><a class="anchor hidden-xs" href="#運作原理0" title="運作原理0"><span class="octicon octicon-link"></span></a>運作原理</h4><ul>
<li>第二層把對磁片的更新按會話打包，它保證這些操作是原子操作（要麼全被應用，要麼都不應用），所以它對實現系統崩潰後的重啟資料恢復很有説明。</li>
<li>它實現的機制是，所有讀寫操作都先寫入磁片中的日誌區，全部都複製到真正需要讀寫的位置之後，再從日誌區中刪除剛才讀寫的資料，所以每個操作都做了兩次。系統崩潰重啟後，會先檢查日誌區，將存在的完整的資料都覆蓋到資料區然後從日誌區刪除，這是“全被應用”，如果資料是不完整的，說明也還沒開始進行第二次的讀寫，這種情況下就是“都不應用”。這樣保證了資料的完整一致性。xv6fs採用固定大小的log區，把大檔切割成小塊，每個寫操作的大小不會超過log區大小，分批次commit。</li>
<li>begin_op()會等待正在commit的操作完成，以及log區剩餘空間滿足所有正準備寫入的資料量。</li>
</ul><pre><code class="javascript hljs"><span class="token number">4826</span>	<span class="token comment">// called at the start of each FS system call.</span>
<span class="token number">4827</span>	<span class="token keyword">void</span>
<span class="token number">4828</span>	<span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">4829</span>	<span class="token punctuation">{</span>
<span class="token number">4830</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4831</span>	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4832</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>committing<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4833</span>	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">,</span> <span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4834</span>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">+</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>outstanding<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token constant">MAXOPBLOCKS</span> <span class="token operator">&gt;</span> <span class="token constant">LOGSIZE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4835</span>	<span class="token comment">// this op might exhaust log space; wait for commit.</span>
<span class="token number">4836</span>	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">,</span> <span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4837</span>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">4838</span>	log<span class="token punctuation">.</span>outstanding <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token comment">//將log的outstanding加一，表示有新的系統調用正在寫日誌。</span>
<span class="token number">4839</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4840</span>	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">4841</span>	<span class="token punctuation">}</span>
<span class="token number">4842</span>	<span class="token punctuation">}</span>
<span class="token number">4843</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>log_write()可以看作是對bwrite()的封裝。但是只是將block加入logheader，保證clock不會別的進程佔用，並不寫資料。</li>
</ul><pre><code class="javascript hljs"><span class="token number">4921</span>	<span class="token keyword">void</span>
<span class="token number">4922</span>	<span class="token function">log_write</span><span class="token punctuation">(</span>struct buf <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token number">4923</span>	<span class="token punctuation">{</span>
<span class="token number">4924</span>	int i<span class="token punctuation">;</span>
<span class="token number">4925</span>	
<span class="token number">4926</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">&gt;=</span> <span class="token constant">LOGSIZE</span> <span class="token operator">||</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">&gt;=</span> log<span class="token punctuation">.</span>size − <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">4927</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"too big a transaction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//比規定的log大小要大</span>
<span class="token number">4928</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>outstanding <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//沒有在寫日誌</span>
<span class="token number">4929</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"log_write outside of trans"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4930</span>	
<span class="token number">4931</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4932</span>	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">4933</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> b−<span class="token operator">&gt;</span>blockno<span class="token punctuation">)</span> <span class="token comment">// log absorbtion</span>
<span class="token number">4934</span>	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment">// log如果發現當前修改的block之前有重複，則會合並兩次修改，減少磁片請求。</span>
<span class="token number">4935</span>	<span class="token punctuation">}</span>
<span class="token number">4936</span>	log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>block<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> b−<span class="token operator">&gt;</span>blockno<span class="token punctuation">;</span>
<span class="token number">4937</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
<span class="token number">4938</span>	log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">4939</span>	b−<span class="token operator">&gt;</span>flags <span class="token operator">|=</span> <span class="token constant">B_DIRTY</span><span class="token punctuation">;</span> <span class="token comment">// prevent eviction</span>
<span class="token comment">//修改block標誌位元為 B_DIRTY 從而保證不會別的進程佔用</span>
<span class="token number">4940</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4941</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>end_op()，結束FS systemcall call時候用。</li>
</ul><pre><code class="javascript hljs"><span class="token number">4850</span>	<span class="token comment">// called at the end of each FS system call.</span>
<span class="token number">4851</span>	<span class="token comment">// commits if this was the last outstanding operation.</span>
<span class="token number">4852</span>	<span class="token keyword">void</span>
<span class="token number">4853</span>	<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">4854</span>	<span class="token punctuation">{</span>
<span class="token number">4855</span>	int do_commit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">4856</span>	
<span class="token number">4857</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4858</span>	log<span class="token punctuation">.</span>outstanding −<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 將log的outstanding運算元減1，</span>
<span class="token number">4859</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>committing<span class="token punctuation">)</span>
<span class="token number">4860</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"log.committing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4861</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>outstanding <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果減為0則進行commit操作</span>
<span class="token number">4862</span>	do_commit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">4863</span>	log<span class="token punctuation">.</span>committing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">4864</span>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment">//否則喚醒其它等待begin_op()的進程</span>
<span class="token number">4865</span>	<span class="token comment">// begin_op() may be waiting for log space,</span>
<span class="token number">4866</span>	<span class="token comment">// and decrementing log.outstanding has decreased</span>
<span class="token number">4867</span>	<span class="token comment">// the amount of reserved space.</span>
<span class="token number">4868</span>	<span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4869</span>	<span class="token punctuation">}</span>
<span class="token number">4870</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4871</span>	
<span class="token number">4872</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>do_commit<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">4873</span>	<span class="token comment">// call commit w/o holding locks, since not allowed</span>
<span class="token number">4874</span>	<span class="token comment">// to sleep with locks.</span>
<span class="token number">4875</span>	<span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4876</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4877</span>	log<span class="token punctuation">.</span>committing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">4878</span>	<span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4879</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4880</span>	<span class="token punctuation">}</span>
<span class="token number">4881</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>Commit()調用write_log()將log資料結構中記錄的buf資料寫入log區，然後write_head()將log資料結構寫入log區中，再將log區的資料拷貝到真正的資料區，，也將log記憶體結構清空，並將磁片log區清空，最後把起始塊中的計數改成0。</li>
</ul><pre><code class="javascript hljs"><span class="token number">4900</span>	<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token number">4901</span>	<span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">4902</span>	<span class="token punctuation">{</span>
<span class="token number">4903</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">4904</span>	<span class="token function">write_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Write modified blocks from cache to log</span>
<span class="token number">4905</span>	<span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Write header to disk −− the real commit</span>
<span class="token number">4906</span>	<span class="token function">install_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now install writes to home locations</span>
<span class="token number">4907</span>	log<span class="token punctuation">.</span>lh<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">4908</span>	<span class="token function">write_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Erase the transaction from the log</span>
<span class="token number">4909</span>	<span class="token punctuation">}</span>
<span class="token number">4910</span>	<span class="token punctuation">}</span>
</code></pre><h4 id="程式流程0"><a class="anchor hidden-xs" href="#程式流程0" title="程式流程0"><span class="octicon octicon-link"></span></a>程式流程</h4><p><img src="https://i.imgur.com/11E9mXh.png" alt=""></p><h3 id="Inodes-and-block-allocator"><a class="anchor hidden-xs" href="#Inodes-and-block-allocator" title="Inodes-and-block-allocator"><span class="octicon octicon-link"></span></a>Inodes and block allocator</h3><h4 id="資料結構fsc"><a class="anchor hidden-xs" href="#資料結構fsc" title="資料結構fsc"><span class="octicon octicon-link"></span></a>資料結構(fs.c)</h4><pre><code class="javascript hljs"><span class="token number">4077</span>	<span class="token comment">// On−disk inode structure</span>
<span class="token number">4078</span>	struct dinode <span class="token punctuation">{</span>
<span class="token number">4079</span>	short type<span class="token punctuation">;</span> <span class="token comment">// File type用來區分檔/目錄和特殊檔的i節點</span>
<span class="token comment">//若type==0那就是空的i節點</span>
<span class="token number">4080</span>	short major<span class="token punctuation">;</span> <span class="token comment">// Major device number (T_DEV only)</span>
<span class="token number">4081</span>	short minor<span class="token punctuation">;</span> <span class="token comment">// Minor device number (T_DEV only)</span>
<span class="token number">4082</span>	short nlink<span class="token punctuation">;</span> <span class="token comment">// Number of links to inode in file system</span>
<span class="token comment">//記錄指向這個i節點的目錄項，用來判斷要不要釋放它</span>
<span class="token number">4083</span>	uint size<span class="token punctuation">;</span> <span class="token comment">// Size of file (bytes)檔的位元組數</span>
<span class="token number">4084</span>	uint addrs<span class="token punctuation">[</span><span class="token constant">NDIRECT</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Data block addresses資料塊的塊號</span>
<span class="token number">4085</span>	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">*</span> 磁片上的inode結構
<span class="token number">4161</span>	<span class="token comment">// in−memory copy of an inode</span>
<span class="token number">4162</span>	struct inode <span class="token punctuation">{</span>
<span class="token number">4163</span>	uint dev<span class="token punctuation">;</span> <span class="token comment">// Device number</span>
<span class="token number">4164</span>	uint inum<span class="token punctuation">;</span> <span class="token comment">// Inode number</span>
<span class="token number">4165</span>	int ref<span class="token punctuation">;</span> <span class="token comment">// Reference count用來統計指向它的指標個數，//如果是0，內核就會拋棄這個inode</span>
<span class="token number">4166</span>	struct sleeplock lock<span class="token punctuation">;</span> <span class="token comment">// protects everything below here</span>
<span class="token number">4167</span>	int valid<span class="token punctuation">;</span> <span class="token comment">// inode has been read from disk?</span>
<span class="token number">4168</span>	
<span class="token number">4169</span>	short type<span class="token punctuation">;</span> <span class="token comment">// copy of disk inode同上</span>
<span class="token number">4170</span>	short major<span class="token punctuation">;</span>
<span class="token number">4171</span>	short minor<span class="token punctuation">;</span>
<span class="token number">4172</span>	short nlink<span class="token punctuation">;</span>
<span class="token number">4173</span>	uint size<span class="token punctuation">;</span>
<span class="token number">4174</span>	uint addrs<span class="token punctuation">[</span><span class="token constant">NDIRECT</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">4175</span>	<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>記憶體上的inode結構（複製），有c指標指向才會把這個i節點保存在記憶體</li>
</ul><h4 id="運作原理0"><a class="anchor hidden-xs" href="#運作原理0" title="運作原理0"><span class="octicon octicon-link"></span></a>運作原理</h4><ul>
<li>xv6塊分配器有一份記憶體inode緩存磁片上的空閒塊點陣圖。功能是分配和釋放塊。</li>
<li>balloc用於分配塊</li>
</ul><pre><code class="javascript hljs"><span class="token number">5014</span>	<span class="token comment">// Allocate a zeroed disk block.</span>
<span class="token number">5015</span>	<span class="token keyword">static</span> uint
<span class="token number">5016</span>	<span class="token function">balloc</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">)</span>
<span class="token number">5017</span>	<span class="token punctuation">{</span>
<span class="token number">5018</span>	int b<span class="token punctuation">,</span> bi<span class="token punctuation">,</span> m<span class="token punctuation">;</span>
<span class="token number">5019</span>	struct buf <span class="token operator">*</span>bp<span class="token punctuation">;</span>
<span class="token number">5020</span>	
<span class="token number">5021</span>	bp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5022</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b <span class="token operator">&lt;</span> sb<span class="token punctuation">.</span>size<span class="token punctuation">;</span> b <span class="token operator">+=</span> <span class="token constant">BPB</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5023</span>	bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">BBLOCK</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5024</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>bi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> bi <span class="token operator">&lt;</span> <span class="token constant">BPB</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">+</span> bi <span class="token operator">&lt;</span> sb<span class="token punctuation">.</span>size<span class="token punctuation">;</span> bi<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5025</span>	m <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bi <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5026</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bp−<span class="token operator">&gt;</span>data<span class="token punctuation">[</span>bi<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// Is block free?</span>
<span class="token number">5027</span>	bp−<span class="token operator">&gt;</span>data<span class="token punctuation">[</span>bi<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">|=</span> m<span class="token punctuation">;</span> <span class="token comment">// Mark block in use.</span>
<span class="token number">5028</span>	<span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5029</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5030</span>	<span class="token function">bzero</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> b <span class="token operator">+</span> bi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5031</span>	<span class="token keyword">return</span> b <span class="token operator">+</span> bi<span class="token punctuation">;</span>
<span class="token number">5032</span>	<span class="token punctuation">}</span>
<span class="token number">5033</span>	<span class="token punctuation">}</span>
<span class="token number">5034</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5035</span>	<span class="token punctuation">}</span>
<span class="token number">5036</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"balloc: out of blocks"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5037</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>bfree用於釋放塊</li>
</ul><pre><code class="javascript hljs"><span class="token number">5050</span>	<span class="token comment">// Free a disk block.</span>
<span class="token number">5051</span>	<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token number">5052</span>	<span class="token function">bfree</span><span class="token punctuation">(</span>int dev<span class="token punctuation">,</span> uint b<span class="token punctuation">)</span>
<span class="token number">5053</span>	<span class="token punctuation">{</span>
<span class="token number">5054</span>	struct buf <span class="token operator">*</span>bp<span class="token punctuation">;</span>
<span class="token number">5055</span>	int bi<span class="token punctuation">,</span> m<span class="token punctuation">;</span>
<span class="token number">5056</span>	
<span class="token number">5057</span>	<span class="token function">readsb</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5058</span>	bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">BBLOCK</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5059</span>	bi <span class="token operator">=</span> b <span class="token operator">%</span> <span class="token constant">BPB</span><span class="token punctuation">;</span>
<span class="token number">5060</span>	m <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bi <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5061</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bp−<span class="token operator">&gt;</span>data<span class="token punctuation">[</span>bi<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5062</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"freeing free block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5063</span>	bp−<span class="token operator">&gt;</span>data<span class="token punctuation">[</span>bi<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>m<span class="token punctuation">;</span>
<span class="token number">5064</span>	<span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5065</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5066</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>i節點指磁片上的記錄檔大小/資料塊磁區號的資料結構，也可以指複製到記憶體的一個i節點。與inode相關的操作主要有ialloc()，iget()，iput()，ilock()，iunlock()。</li>
<li>iget()用來申請i節點指針，會返回i-number的inode記憶體資訊，同時增加ref引用數。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5250</span>	<span class="token comment">// Find the inode with number inum on device dev</span>
<span class="token number">5251</span>	<span class="token comment">// and return the in−memory copy. Does not lock</span>
<span class="token number">5252</span>	<span class="token comment">// the inode and does not read it from disk.</span>
<span class="token number">5253</span>	<span class="token keyword">static</span> struct inode<span class="token operator">*</span>
<span class="token number">5254</span>	<span class="token function">iget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint inum<span class="token punctuation">)</span>
<span class="token number">5255</span>	<span class="token punctuation">{</span>
<span class="token number">5256</span>	struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> <span class="token operator">*</span>empty<span class="token punctuation">;</span>
<span class="token number">5257</span>	
<span class="token number">5258</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5259</span>	
<span class="token number">5260</span>	<span class="token comment">// Is the inode already cached?</span>
<span class="token number">5261</span>	empty <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5262</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>inode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ip <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>inode<span class="token punctuation">[</span><span class="token constant">NINODE</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ip<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5263</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>ref <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ip−<span class="token operator">&gt;</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> ip−<span class="token operator">&gt;</span>inum <span class="token operator">==</span> inum<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5264</span>	ip−<span class="token operator">&gt;</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">5265</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5266</span>	<span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token number">5267</span>	<span class="token punctuation">}</span>
<span class="token number">5268</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>empty <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ip−<span class="token operator">&gt;</span>ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// Remember empty slot.</span>
<span class="token number">5269</span>	empty <span class="token operator">=</span> ip<span class="token punctuation">;</span>
<span class="token number">5270</span>	<span class="token punctuation">}</span>
<span class="token number">5271</span>	
<span class="token number">5272</span>	<span class="token comment">// Recycle an inode cache entry.</span>
<span class="token number">5273</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>empty <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5274</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"iget: no inodes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5275</span>	
<span class="token number">5276</span>	ip <span class="token operator">=</span> empty<span class="token punctuation">;</span>
<span class="token number">5277</span>	ip−<span class="token operator">&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
<span class="token number">5278</span>	ip−<span class="token operator">&gt;</span>inum <span class="token operator">=</span> inum<span class="token punctuation">;</span>
<span class="token number">5279</span>	ip−<span class="token operator">&gt;</span>ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5280</span>	ip−<span class="token operator">&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5281</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5282</span>	
<span class="token number">5283</span>	<span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token number">5284</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>iput()用來釋放指針，會減少引用數，如果引用和其自身link都為0時，說明該inode對應的檔已被刪除，應該回收該inode及其所有blocks。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5350</span>	<span class="token comment">// Drop a reference to an in−memory inode.</span>
<span class="token number">5351</span>	<span class="token comment">// If that was the last reference, the inode cache entry can</span>
<span class="token number">5352</span>	<span class="token comment">// be recycled.</span>
<span class="token number">5353</span>	<span class="token comment">// If that was the last reference and the inode has no links</span>
<span class="token number">5354</span>	<span class="token comment">// to it, free the inode (and its content) on disk.</span>
<span class="token number">5355</span>	<span class="token comment">// All calls to iput() must be inside a transaction in</span>
<span class="token number">5356</span>	<span class="token comment">// case it has to free the inode.</span>
<span class="token number">5357</span>	<span class="token keyword">void</span>
<span class="token number">5358</span>	<span class="token function">iput</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">)</span>
<span class="token number">5359</span>	<span class="token punctuation">{</span>
<span class="token number">5360</span>	<span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5361</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>valid <span class="token operator">&amp;&amp;</span> ip−<span class="token operator">&gt;</span>nlink <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5362</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5363</span>	int r <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>ref<span class="token punctuation">;</span>
<span class="token number">5364</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5365</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5366</span>	<span class="token comment">// inode has no links and no other references: truncate and free.</span>
<span class="token number">5367</span>	<span class="token function">itrunc</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5368</span>	ip−<span class="token operator">&gt;</span>type <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5369</span>	<span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5370</span>	ip−<span class="token operator">&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5371</span>	<span class="token punctuation">}</span>
<span class="token number">5372</span>	<span class="token punctuation">}</span>
<span class="token number">5373</span>	<span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5374</span>	
<span class="token number">5375</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5376</span>	ip−<span class="token operator">&gt;</span>ref−−<span class="token punctuation">;</span>
<span class="token number">5377</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5378</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>ilock()，iunlock()通過修改inode的flags標誌位元保證一個inode只能被一個進程使用。</li>
<li>ilock（）用來保證inode擁有磁片的有效拷貝，它鎖住i節點，防止其他進程使用它，並且讀出還沒有被讀出的資訊。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5300</span>	<span class="token comment">// Lock the given inode.</span>
<span class="token number">5301</span>	<span class="token comment">// Reads the inode from disk if necessary.</span>
<span class="token number">5302</span>	<span class="token keyword">void</span>
<span class="token number">5303</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">)</span>
<span class="token number">5304</span>	<span class="token punctuation">{</span>
<span class="token number">5305</span>	struct buf <span class="token operator">*</span>bp<span class="token punctuation">;</span>
<span class="token number">5306</span>	struct dinode <span class="token operator">*</span>dip<span class="token punctuation">;</span>
<span class="token number">5307</span>	
<span class="token number">5308</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> ip−<span class="token operator">&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">5309</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"ilock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5310</span>	
<span class="token number">5311</span>	<span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5312</span>	
<span class="token number">5313</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>valid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5314</span>	bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">,</span> <span class="token constant">IBLOCK</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>inum<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5315</span>	dip <span class="token operator">=</span> <span class="token punctuation">(</span>struct dinode<span class="token operator">*</span><span class="token punctuation">)</span>bp−<span class="token operator">&gt;</span>data <span class="token operator">+</span> ip−<span class="token operator">&gt;</span>inum<span class="token operator">%</span><span class="token constant">IPB</span><span class="token punctuation">;</span>
<span class="token number">5316</span>	ip−<span class="token operator">&gt;</span>type <span class="token operator">=</span> dip−<span class="token operator">&gt;</span>type<span class="token punctuation">;</span>
<span class="token number">5317</span>	ip−<span class="token operator">&gt;</span>major <span class="token operator">=</span> dip−<span class="token operator">&gt;</span>major<span class="token punctuation">;</span>
<span class="token number">5318</span>	ip−<span class="token operator">&gt;</span>minor <span class="token operator">=</span> dip−<span class="token operator">&gt;</span>minor<span class="token punctuation">;</span>
<span class="token number">5319</span>	ip−<span class="token operator">&gt;</span>nlink <span class="token operator">=</span> dip−<span class="token operator">&gt;</span>nlink<span class="token punctuation">;</span>
<span class="token number">5320</span>	ip−<span class="token operator">&gt;</span>size <span class="token operator">=</span> dip−<span class="token operator">&gt;</span>size<span class="token punctuation">;</span>
<span class="token number">5321</span>	<span class="token function">memmove</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">,</span> dip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5322</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5323</span>	ip−<span class="token operator">&gt;</span>valid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5324</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5325</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"ilock: no type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5326</span>	<span class="token punctuation">}</span>
<span class="token number">5327</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>相應的就有iunlock用來解鎖i節點，清除I_busy的標記，並且喚醒睡眠在ilock的其他進程。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5329</span>	<span class="token comment">// Unlock the given inode.</span>
<span class="token number">5330</span>	<span class="token keyword">void</span>
<span class="token number">5331</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">)</span>
<span class="token number">5332</span>	<span class="token punctuation">{</span>
<span class="token number">5333</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span> <span class="token operator">||</span> ip−<span class="token operator">&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">5334</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"iunlock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5335</span>	
<span class="token number">5336</span>	<span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip−<span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5337</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>磁片上的 i 節點結構，結構體 dinode，記錄了 i 節點的大小和資料塊的塊號陣列。i 節點資料能夠在dinode 的 adddrs 陣列中被找到。最開始的 NDIRECT 個塊存在於這個陣列的前 NDIRECT個項；這些塊被稱作直接塊。接下來的 NINDIRECT 個塊的資料在 i 節點中列了出來但並沒有直接存在 i 節點中，它們存在於一個叫做間接塊的資料塊中。addrs 陣列的最後一項就是間接塊的位址。與inode content相關的主要有writei()，readi()，以及與block相關的bmap()，balloc()，bfree()。</li>
</ul><p><img src="https://i.imgur.com/GI66fSu.png" alt=""></p><ul>
<li>bmap 是一個簡化操作的工具，返回 i 節點 ip 中的第 bn個資料塊，如果 ip 還沒有這樣一個資料塊，bmap 就會分配一個。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5400</span>	<span class="token comment">// Inode content</span>
<span class="token number">5401</span>	<span class="token comment">//</span>
<span class="token number">5402</span>	<span class="token comment">// The content (data) associated with each inode is stored</span>
<span class="token number">5403</span>	<span class="token comment">// in blocks on the disk. The first NDIRECT block numbers</span>
<span class="token number">5404</span>	<span class="token comment">// are listed in ip−&gt;addrs[]. The next NINDIRECT blocks are</span>
<span class="token number">5405</span>	<span class="token comment">// listed in block ip−&gt;addrs[NDIRECT].</span>
<span class="token number">5406</span>	
<span class="token number">5407</span>	<span class="token comment">// Return the disk block address of the nth block in inode ip.</span>
<span class="token number">5408</span>	<span class="token comment">// If there is no such block, bmap allocates one.</span>
<span class="token number">5409</span>	<span class="token keyword">static</span> uint
<span class="token number">5410</span>	<span class="token function">bmap</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> uint bn<span class="token punctuation">)</span>
<span class="token number">5411</span>	<span class="token punctuation">{</span>
<span class="token number">5412</span>	uint addr<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>
<span class="token number">5413</span>	struct buf <span class="token operator">*</span>bp<span class="token punctuation">;</span>
</code></pre><ul>
<li>函數 bmap（4810）從最簡單的情況開始：前面的 NDIRECT 個塊的資料就在 i 節點本身中。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5415</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> <span class="token constant">NDIRECT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5416</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5417</span>	ip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5418</span>	<span class="token keyword">return</span> addr<span class="token punctuation">;</span>
<span class="token number">5419</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>後面的 NINDIRECT 個塊在 ip-&gt;addrs[NDIRECT] 指向的間接塊中（4826）。bmap 讀出間接塊然後再從正確的位置讀出一個塊號。如果這個塊號超出了NDIRECT+NINDRECT，bmap就報錯。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5420</span>	bn −<span class="token operator">=</span> <span class="token constant">NDIRECT</span><span class="token punctuation">;</span>	
<span class="token number">5421</span>		
<span class="token number">5422</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> <span class="token constant">NINDIRECT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	
<span class="token number">5423</span>	<span class="token comment">// Load indirect block, allocating if necessary.	</span>
<span class="token number">5424</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">[</span><span class="token constant">NDIRECT</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>	
<span class="token number">5425</span>	ip−<span class="token operator">&gt;</span>addrs<span class="token punctuation">[</span><span class="token constant">NDIRECT</span><span class="token punctuation">]</span> <span class="token operator">=</span> addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">5426</span>	bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">5427</span>	a <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token operator">*</span><span class="token punctuation">)</span>bp−<span class="token operator">&gt;</span>data<span class="token punctuation">;</span>	
<span class="token number">5428</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5429</span>	a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">5430</span>	<span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">5431</span>	<span class="token punctuation">}</span>	
<span class="token number">5432</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">5433</span>	<span class="token keyword">return</span> addr<span class="token punctuation">;</span>	
<span class="token number">5434</span>	<span class="token punctuation">}</span>	
<span class="token number">5435</span>		
<span class="token number">5436</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bmap: out of range"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token number">5437</span>	<span class="token punctuation">}</span>	
</code></pre><ul>
<li>bmap服務於像 readi 和 writei 這樣的介面，因為檔的一部分可以從i節點直接取出而不用間接取址。readi從 i 節點中讀出資料。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5500</span>	<span class="token comment">// Read data from inode.</span>
<span class="token number">5501</span>	<span class="token comment">// Caller must hold ip−&gt;lock.</span>
<span class="token number">5502</span>	int
<span class="token number">5503</span>	<span class="token function">readi</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> char <span class="token operator">*</span>dst<span class="token punctuation">,</span> uint off<span class="token punctuation">,</span> uint n<span class="token punctuation">)</span>
<span class="token number">5504</span>	<span class="token punctuation">{</span>
<span class="token number">5505</span>	uint tot<span class="token punctuation">,</span> m<span class="token punctuation">;</span>
<span class="token number">5506</span>	struct buf <span class="token operator">*</span>bp<span class="token punctuation">;</span>
</code></pre><ul>
<li>它最開始要保證給定的偏移和讀出的量沒有超出檔的末尾。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5508</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">T_DEV</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// 檢查 ip-&gt;type == T_DEV。這是為了處理一些資料不存在檔案系統中的特殊設備</span>
<span class="token number">5509</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>major <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ip−<span class="token operator">&gt;</span>major <span class="token operator">&gt;=</span> <span class="token constant">NDEV</span> <span class="token operator">||</span> <span class="token operator">!</span>devsw<span class="token punctuation">[</span>ip−<span class="token operator">&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">)</span>
<span class="token number">5510</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5511</span>	<span class="token keyword">return</span> devsw<span class="token punctuation">[</span>ip−<span class="token operator">&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5512</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>從超出檔末尾的地方讀會直接返回錯誤，</li>
</ul><pre><code class="javascript hljs"><span class="token number">5514</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>off <span class="token operator">&gt;</span> ip−<span class="token operator">&gt;</span>size <span class="token operator">||</span> off <span class="token operator">+</span> n <span class="token operator">&lt;</span> off<span class="token punctuation">)</span>
<span class="token number">5515</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>如果是讀的過程當中超出了檔末尾就會返回比請求的資料量少的資料（從讀開始的地方到檔末尾的資料，這是所有的能返回的資料）。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5516</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>off <span class="token operator">+</span> n <span class="token operator">&gt;</span> ip−<span class="token operator">&gt;</span>size<span class="token punctuation">)</span>
<span class="token number">5517</span>	n <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>size − off<span class="token punctuation">;</span>
</code></pre><ul>
<li>一個迴圈處理檔的每一塊，從緩衝區中拷貝資料到 dst 中。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5519</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>tot<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> tot<span class="token operator">&lt;</span>n<span class="token punctuation">;</span> tot<span class="token operator">+=</span>m<span class="token punctuation">,</span> off<span class="token operator">+=</span>m<span class="token punctuation">,</span> dst<span class="token operator">+=</span>m<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5520</span>	bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">,</span> <span class="token function">bmap</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> off<span class="token operator">/</span><span class="token constant">BSIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5521</span>	m <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>n − tot<span class="token punctuation">,</span> <span class="token constant">BSIZE</span> − off<span class="token operator">%</span><span class="token constant">BSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5522</span>	<span class="token function">memmove</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> bp−<span class="token operator">&gt;</span>data <span class="token operator">+</span> off<span class="token operator">%</span><span class="token constant">BSIZE</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5523</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5524</span>	<span class="token punctuation">}</span>
<span class="token number">5525</span>	<span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token number">5526</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>函數 writei和 readi 幾乎是一樣的，只有三個不同：1) 從檔超出檔末尾的地方開始的寫或者寫的過程中超出檔末尾的話會增長這個檔，直到達到最大的檔大小。2) 這個迴圈把資料寫入緩衝區而非拷出緩衝區。3) 如果寫操作延伸了這個檔，writei 必須更新它的大小）。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5550</span>	<span class="token comment">// Write data to inode.</span>
<span class="token number">5551</span>	<span class="token comment">// Caller must hold ip−&gt;lock.</span>
<span class="token number">5552</span>	int
<span class="token number">5553</span>	<span class="token function">writei</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> char <span class="token operator">*</span>src<span class="token punctuation">,</span> uint off<span class="token punctuation">,</span> uint n<span class="token punctuation">)</span>
<span class="token number">5554</span>	<span class="token punctuation">{</span>
<span class="token number">5555</span>	uint tot<span class="token punctuation">,</span> m<span class="token punctuation">;</span>
<span class="token number">5556</span>	struct buf <span class="token operator">*</span>bp<span class="token punctuation">;</span>
<span class="token number">5557</span>	<span class="token comment">// 檢查 ip-&gt;type == T_DEV為了處理一些資料不存在檔案系統中的特殊設備</span>
<span class="token number">5558</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">T_DEV</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5559</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>major <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ip−<span class="token operator">&gt;</span>major <span class="token operator">&gt;=</span> <span class="token constant">NDEV</span> <span class="token operator">||</span> <span class="token operator">!</span>devsw<span class="token punctuation">[</span>ip−<span class="token operator">&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span>write<span class="token punctuation">)</span>
<span class="token number">5560</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5561</span>	<span class="token keyword">return</span> devsw<span class="token punctuation">[</span>ip−<span class="token operator">&gt;</span>major<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> src<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5562</span>	<span class="token punctuation">}</span>
<span class="token number">5563</span>	
<span class="token number">5564</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>off <span class="token operator">&gt;</span> ip−<span class="token operator">&gt;</span>size <span class="token operator">||</span> off <span class="token operator">+</span> n <span class="token operator">&lt;</span> off<span class="token punctuation">)</span>
<span class="token number">5565</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5566</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>off <span class="token operator">+</span> n <span class="token operator">&gt;</span> <span class="token constant">MAXFILE</span><span class="token operator">*</span><span class="token constant">BSIZE</span><span class="token punctuation">)</span>
<span class="token number">5567</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5568</span>	
<span class="token number">5569</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>tot<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> tot<span class="token operator">&lt;</span>n<span class="token punctuation">;</span> tot<span class="token operator">+=</span>m<span class="token punctuation">,</span> off<span class="token operator">+=</span>m<span class="token punctuation">,</span> src<span class="token operator">+=</span>m<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5570</span>	bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">,</span> <span class="token function">bmap</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> off<span class="token operator">/</span><span class="token constant">BSIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5571</span>	m <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>n − tot<span class="token punctuation">,</span> <span class="token constant">BSIZE</span> − off<span class="token operator">%</span><span class="token constant">BSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5572</span>	<span class="token function">memmove</span><span class="token punctuation">(</span>bp−<span class="token operator">&gt;</span>data <span class="token operator">+</span> off<span class="token operator">%</span><span class="token constant">BSIZE</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5573</span>	<span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5574</span>	<span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5575</span>	<span class="token punctuation">}</span>
<span class="token number">5576</span>	
<span class="token number">5577</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> off <span class="token operator">&gt;</span> ip−<span class="token operator">&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5578</span>	ip−<span class="token operator">&gt;</span>size <span class="token operator">=</span> off<span class="token punctuation">;</span>
<span class="token number">5579</span>	<span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5580</span>	<span class="token punctuation">}</span>
<span class="token number">5581</span>	<span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token number">5582</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>函數 stati把 i 節點的中繼資料拷貝到 stat 結構體中，這個結構體可通過系統調用 stat 暴露給使用者程式。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5485</span>	<span class="token comment">// Copy stat information from inode.</span>
<span class="token number">5486</span>	<span class="token comment">// Caller must hold ip−&gt;lock.</span>
<span class="token number">5487</span>	<span class="token keyword">void</span>
<span class="token number">5488</span>	<span class="token function">stati</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> struct stat <span class="token operator">*</span>st<span class="token punctuation">)</span>
<span class="token number">5489</span>	<span class="token punctuation">{</span>
<span class="token number">5490</span>	st−<span class="token operator">&gt;</span>dev <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>dev<span class="token punctuation">;</span>
<span class="token number">5491</span>	st−<span class="token operator">&gt;</span>ino <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>inum<span class="token punctuation">;</span>
<span class="token number">5492</span>	st−<span class="token operator">&gt;</span>type <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>type<span class="token punctuation">;</span>
<span class="token number">5493</span>	st−<span class="token operator">&gt;</span>nlink <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>nlink<span class="token punctuation">;</span>
<span class="token number">5494</span>	st−<span class="token operator">&gt;</span>size <span class="token operator">=</span> ip−<span class="token operator">&gt;</span>size<span class="token punctuation">;</span>
<span class="token number">5495</span>	<span class="token punctuation">}</span>
</code></pre><h4 id="程式流程0"><a class="anchor hidden-xs" href="#程式流程0" title="程式流程0"><span class="octicon octicon-link"></span></a>程式流程</h4><p><img src="https://i.imgur.com/aeRrQaj.png" alt=""></p><h3 id="Directories（Directory-inodes）"><a class="anchor hidden-xs" href="#Directories（Directory-inodes）" title="Directories（Directory-inodes）"><span class="octicon octicon-link"></span></a>Directories（Directory inodes）</h3><h4 id="資料結構fshfsc"><a class="anchor hidden-xs" href="#資料結構fshfsc" title="資料結構fshfsc"><span class="octicon octicon-link"></span></a>資料結構(fs.h/fs.c)</h4><pre><code class="javascript hljs"><span class="token number">4115</span>	struct dirent <span class="token punctuation">{</span>
<span class="token number">4116</span>	ushort inum<span class="token punctuation">;</span><span class="token comment">//目錄號</span>
<span class="token number">4117</span>	char name<span class="token punctuation">[</span><span class="token constant">DIRSIZ</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//目錄名</span>
<span class="token number">4118</span>	<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h4 id="運作原理0"><a class="anchor hidden-xs" href="#運作原理0" title="運作原理0"><span class="octicon octicon-link"></span></a>運作原理</h4><ul>
<li>第四層把目錄實現為一種特殊的i節點，它的內容是一連串的目錄項，每一個目錄項包含一個檔案名和對應的i節點。</li>
<li>目錄層主要提供了inode內容到目錄的抽象。目錄被看作是一種特殊的檔，檔內容是該目錄含有的檔案名及其inum，用資料結構 struct dirent 來表示。</li>
<li>dirlookup()實現了按照名字在一 T_DIR 類型inode中查找，並返回對應的inode。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5608</span>	<span class="token comment">// Look for a directory entry in a directory.</span>
<span class="token number">5609</span>	<span class="token comment">// If found, set *poff to byte offset of entry.</span>
<span class="token number">5610</span>	struct inode<span class="token operator">*</span>
<span class="token number">5611</span>	<span class="token function">dirlookup</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>dp<span class="token punctuation">,</span> char <span class="token operator">*</span>name<span class="token punctuation">,</span> uint <span class="token operator">*</span>poff<span class="token punctuation">)</span>
<span class="token number">5612</span>	<span class="token punctuation">{</span>
<span class="token number">5613</span>	uint off<span class="token punctuation">,</span> inum<span class="token punctuation">;</span>
<span class="token number">5614</span>	struct dirent de<span class="token punctuation">;</span>
<span class="token number">5615</span>	
<span class="token number">5616</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>dp−<span class="token operator">&gt;</span>type <span class="token operator">!=</span> <span class="token constant">T_DIR</span><span class="token punctuation">)</span>
<span class="token number">5617</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"dirlookup not DIR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5618</span>	
<span class="token number">5619</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> off <span class="token operator">&lt;</span> dp−<span class="token operator">&gt;</span>size<span class="token punctuation">;</span> off <span class="token operator">+=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5620</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">readi</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> <span class="token punctuation">(</span>char<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>de<span class="token punctuation">,</span> off<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">5621</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"dirlookup read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5622</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>inum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5623</span>	<span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">5624</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">namecmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> de<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5625</span>	<span class="token comment">// entry matches path element</span>
<span class="token number">5626</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>poff<span class="token punctuation">)</span>
<span class="token number">5627</span>	<span class="token operator">*</span>poff <span class="token operator">=</span> off<span class="token punctuation">;</span>
<span class="token number">5628</span>	inum <span class="token operator">=</span> de<span class="token punctuation">.</span>inum<span class="token punctuation">;</span>
<span class="token number">5629</span>	<span class="token keyword">return</span> <span class="token function">iget</span><span class="token punctuation">(</span>dp−<span class="token operator">&gt;</span>dev<span class="token punctuation">,</span> inum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5630</span>	<span class="token punctuation">}</span>
<span class="token number">5631</span>	<span class="token punctuation">}</span>
<span class="token number">5632</span>	
<span class="token number">5633</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5634</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>dirlink()實現了將(name, inum)插入到相應inode中。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5650</span>	<span class="token comment">// Write a new directory entry (name, inum) into the directory dp.</span>
<span class="token number">5651</span>	int
<span class="token number">5652</span>	<span class="token function">dirlink</span><span class="token punctuation">(</span>struct inode <span class="token operator">*</span>dp<span class="token punctuation">,</span> char <span class="token operator">*</span>name<span class="token punctuation">,</span> uint inum<span class="token punctuation">)</span>
<span class="token number">5653</span>	<span class="token punctuation">{</span>
<span class="token number">5654</span>	int off<span class="token punctuation">;</span>
<span class="token number">5655</span>	struct dirent de<span class="token punctuation">;</span>
<span class="token number">5656</span>	struct inode <span class="token operator">*</span>ip<span class="token punctuation">;</span>
<span class="token number">5657</span>	
<span class="token number">5658</span>	<span class="token comment">// Check that name is not present.</span>
<span class="token number">5659</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">dirlookup</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5660</span>	<span class="token function">iput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5661</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5662</span>	<span class="token punctuation">}</span>
<span class="token number">5663</span>	
<span class="token number">5664</span>	<span class="token comment">// Look for an empty dirent.</span>
<span class="token number">5665</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> off <span class="token operator">&lt;</span> dp−<span class="token operator">&gt;</span>size<span class="token punctuation">;</span> off <span class="token operator">+=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5666</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">readi</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> <span class="token punctuation">(</span>char<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>de<span class="token punctuation">,</span> off<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">5667</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"dirlink read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5668</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>inum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5669</span>	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">5670</span>	<span class="token punctuation">}</span>
<span class="token number">5671</span>	
<span class="token number">5672</span>	<span class="token function">strncpy</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token constant">DIRSIZ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5673</span>	de<span class="token punctuation">.</span>inum <span class="token operator">=</span> inum<span class="token punctuation">;</span>
<span class="token number">5674</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">writei</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> <span class="token punctuation">(</span>char<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>de<span class="token punctuation">,</span> off<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">5675</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"dirlink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5676</span>	
<span class="token number">5677</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5678</span>	<span class="token punctuation">}</span>
</code></pre><h4 id="程式流程0"><a class="anchor hidden-xs" href="#程式流程0" title="程式流程0"><span class="octicon octicon-link"></span></a>程式流程</h4><p><img src="https://i.imgur.com/N0UiYyh.png" alt=""></p><h3 id="Pathnames（Recursive-lookup）"><a class="anchor hidden-xs" href="#Pathnames（Recursive-lookup）" title="Pathnames（Recursive-lookup）"><span class="octicon octicon-link"></span></a>Pathnames（Recursive lookup）</h3><h4 id="資料結構"><a class="anchor hidden-xs" href="#資料結構" title="資料結構"><span class="octicon octicon-link"></span></a>資料結構</h4><p>同inodes。</p><h4 id="運作原理0"><a class="anchor hidden-xs" href="#運作原理0" title="運作原理0"><span class="octicon octicon-link"></span></a>運作原理</h4><ul>
<li>第五層提供了層次路徑名，通過遞迴的方式來查詢路徑對應的檔。</li>
<li>這一層實現了inode的命名，可以根據pathname得到相應檔的inode。在這一層的namex函數中，對於不同目錄層級檔案名的查找是分開加鎖的而不是整個迴圈一把大鎖，這樣可以使得不同進程的檔查找得以並存執行。這也得益於iget()和ilock()是分開的而不是像bread()訪問和鎖是合起來的，同時inode的訪問和鎖分開防止了一個鎖死問題。</li>
<li>namei解析 path 並返回對應的i 節點</li>
</ul><pre><code class="javascript hljs"><span class="token number">5789</span>	struct inode<span class="token operator">*</span>
<span class="token number">5790</span>	<span class="token function">namei</span><span class="token punctuation">(</span>char <span class="token operator">*</span>path<span class="token punctuation">)</span>
<span class="token number">5791</span>	<span class="token punctuation">{</span>
<span class="token number">5792</span>	char name<span class="token punctuation">[</span><span class="token constant">DIRSIZ</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">5793</span>	<span class="token keyword">return</span> <span class="token function">namex</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5794</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>函數 nameiparent 是一個變種；它在最後一個元素之前停止，返回上級目錄的 i 節點並且把最後一個元素拷貝到name中。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5800</span>	struct inode<span class="token operator">*</span>
<span class="token number">5801</span>	<span class="token function">nameiparent</span><span class="token punctuation">(</span>char <span class="token operator">*</span>path<span class="token punctuation">,</span> char <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token number">5802</span>	<span class="token punctuation">{</span>
<span class="token number">5803</span>	<span class="token keyword">return</span> <span class="token function">namex</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5804</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>namex會計算路徑解析從什麼地方開始。如果路徑以反斜線開始，解析就會從根目錄開始；其他情況下則會從目前的目錄開始。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5750</span>	<span class="token comment">// Look up and return the inode for a path name.</span>
<span class="token number">5751</span>	<span class="token comment">// If parent != 0, return the inode for the parent and copy the final</span>
<span class="token number">5752</span>	<span class="token comment">// path element into name, which must have room for DIRSIZ bytes.</span>
<span class="token number">5753</span>	<span class="token comment">// Must be called inside a transaction since it calls iput().</span>
<span class="token number">5754</span>	<span class="token keyword">static</span> struct inode<span class="token operator">*</span>
<span class="token number">5755</span>	<span class="token function">namex</span><span class="token punctuation">(</span>char <span class="token operator">*</span>path<span class="token punctuation">,</span> int nameiparent<span class="token punctuation">,</span> char <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token number">5756</span>	<span class="token punctuation">{</span>
<span class="token number">5757</span>	struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token number">5758</span>	
<span class="token number">5759</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>path <span class="token operator">==</span> ’<span class="token operator">/</span>’<span class="token punctuation">)</span>
<span class="token number">5760</span>	ip <span class="token operator">=</span> <span class="token function">iget</span><span class="token punctuation">(</span><span class="token constant">ROOTDEV</span><span class="token punctuation">,</span> <span class="token constant">ROOTINO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5761</span>	<span class="token keyword">else</span>
<span class="token number">5762</span>	ip <span class="token operator">=</span> <span class="token function">idup</span><span class="token punctuation">(</span><span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>−<span class="token operator">&gt;</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>然後它使用 skipelem 來依次考慮路徑中的每一個部分。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5764</span>	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token function">skipelem</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
</code></pre><ul>
<li>每一次迴圈反覆運算都必須在當前的 i 節點 ip 中找 name。迴圈的開始會把 ip 鎖住，然後檢查它是否確然是一個目錄。如果它不是目錄的話，查詢就宣告失敗。（鎖住 ip 是必須的，不是因為 ip-&gt;type 隨時有可能變（事實上它不會變），而是因為如果不調用 ilock 的話，ip-&gt;type 可能還沒有從磁片中載入出來）。如果是調用 nameiparent 而且這是最後一個路徑元素，那麼迴圈就直接結束了。因為最後一個路徑元素已經拷貝到了 name 中，所以 namex 只需要返回解鎖的 ip。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5765</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5766</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>type <span class="token operator">!=</span> <span class="token constant">T_DIR</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5767</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5768</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5769</span>	<span class="token punctuation">}</span>
<span class="token number">5770</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>nameiparent <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>path <span class="token operator">==</span> ’\<span class="token number">0</span>’<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5771</span>	<span class="token comment">// Stop one level early.</span>
<span class="token number">5772</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5773</span>	<span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token number">5774</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>最後，迴圈用 dirlookup 尋找路徑元素並且令 ip=next，準備下一次的迴圈。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5775</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>next <span class="token operator">=</span> <span class="token function">dirlookup</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5776</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5777</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5778</span>	<span class="token punctuation">}</span>
<span class="token number">5779</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5780</span>	ip <span class="token operator">=</span> next<span class="token punctuation">;</span>
<span class="token number">5781</span>	<span class="token punctuation">}</span>
<span class="token number">5782</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>nameiparent<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5783</span>	<span class="token function">iput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5784</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5785</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>當迴圈處理了每一個路徑元素後，它返回 ip</li>
</ul><pre><code class="javascript hljs"><span class="token number">5786</span>	<span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token number">5787</span>	<span class="token punctuation">}</span>
</code></pre><h4 id="程式流程0"><a class="anchor hidden-xs" href="#程式流程0" title="程式流程0"><span class="octicon octicon-link"></span></a>程式流程</h4><p><img src="https://i.imgur.com/HPK1VX6.png" alt=""></p><h3 id="System-calls（File-descriptors）"><a class="anchor hidden-xs" href="#System-calls（File-descriptors）" title="System-calls（File-descriptors）"><span class="octicon octicon-link"></span></a>System calls（File descriptors）</h3><h4 id="資料結構（filecsysfilec）"><a class="anchor hidden-xs" href="#資料結構（filecsysfilec）" title="資料結構（filecsysfilec）"><span class="octicon octicon-link"></span></a>資料結構（file.c/sysfile.c）</h4><pre><code class="javascript hljs"><span class="token number">4150</span>	struct file <span class="token punctuation">{</span>
<span class="token number">4151</span>	<span class="token keyword">enum</span> <span class="token punctuation">{</span> <span class="token constant">FD_NONE</span><span class="token punctuation">,</span> <span class="token constant">FD_PIPE</span><span class="token punctuation">,</span> <span class="token constant">FD_INODE</span> <span class="token punctuation">}</span> type<span class="token punctuation">;</span>
<span class="token comment">//枚舉三種檔案類型</span>
<span class="token number">4152</span>	int ref<span class="token punctuation">;</span> <span class="token comment">// reference count//指針計數</span>
<span class="token number">4153</span>	char readable<span class="token punctuation">;</span><span class="token comment">//用來記錄檔用於讀</span>
<span class="token number">4154</span>	char writable<span class="token punctuation">;</span> <span class="token comment">//用來記錄檔用於寫</span>
<span class="token number">4155</span>	struct pipe <span class="token operator">*</span>pipe<span class="token punctuation">;</span>
<span class="token number">4156</span>	struct inode <span class="token operator">*</span>ip<span class="token punctuation">;</span>
<span class="token number">4157</span>	uint off<span class="token punctuation">;</span>
<span class="token number">4158</span>	<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h4 id="運作原理"><a class="anchor hidden-xs" href="#運作原理" title="運作原理"><span class="octicon octicon-link"></span></a>運作原理</h4><ul>
<li>第六層將很多UNIX的資源抽象為檔案系統的介面。就是系統調用，read()，write()之類，以及相關的實現。UNIX一個重要思想是所有資源都可以看作是檔，File Descriptor是實現這一思想的重要途徑。xv6用結構體 struct file 來表示檔，在每個進程中記錄有自己打開的檔指標。</li>
<li>全域的文件表 ftable，用來存放有的打開文件。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5863</span>	struct <span class="token punctuation">{</span>
<span class="token number">5864</span>	struct spinlock lock<span class="token punctuation">;</span>
<span class="token number">5865</span>	struct file file<span class="token punctuation">[</span><span class="token constant">NFILE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">5866</span>	<span class="token punctuation">}</span> ftable<span class="token punctuation">;</span>
</code></pre><ul>
<li>這個檔表有一個分配檔的函數（filealloc），有一個重複引用檔的函數（filedup），釋放對檔引用的函數（fileclose），讀和寫檔的函數（fileread 和 filewrite ）。</li>
<li>Filealloc 掃描整個檔表來尋找一個沒有被引用的檔（file-&gt;ref == 0)並且返回一個新的引用；</li>
</ul><pre><code class="javascript hljs"><span class="token number">5874</span>	<span class="token comment">// Allocate a file structure.</span>
<span class="token number">5875</span>	struct file<span class="token operator">*</span>
<span class="token number">5876</span>	<span class="token function">filealloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">5877</span>	<span class="token punctuation">{</span>
<span class="token number">5878</span>	struct file <span class="token operator">*</span>f<span class="token punctuation">;</span>
<span class="token number">5879</span>	
<span class="token number">5880</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5881</span>	<span class="token keyword">for</span><span class="token punctuation">(</span>f <span class="token operator">=</span> ftable<span class="token punctuation">.</span>file<span class="token punctuation">;</span> f <span class="token operator">&lt;</span> ftable<span class="token punctuation">.</span>file <span class="token operator">+</span> <span class="token constant">NFILE</span><span class="token punctuation">;</span> f<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5882</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5883</span>	f−<span class="token operator">&gt;</span>ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5884</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5885</span>	<span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token number">5886</span>	<span class="token punctuation">}</span>
<span class="token number">5887</span>	<span class="token punctuation">}</span>
<span class="token number">5888</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5889</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5890</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>filedup 增加引用計數；fileclose 減少引用計數。當一個檔的引用計數變為0的時候，fileclose就會釋放掉當前的管道或者i 節點（根據檔案類型的不同）。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5900</span>	<span class="token comment">// Increment ref count for file f.</span>
<span class="token number">5901</span>	struct file<span class="token operator">*</span>
<span class="token number">5902</span>	<span class="token function">filedup</span><span class="token punctuation">(</span>struct file <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token number">5903</span>	<span class="token punctuation">{</span>
<span class="token number">5904</span>	<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5905</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ref <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">5906</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"filedup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5907</span>	f−<span class="token operator">&gt;</span>ref<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">5908</span>	<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ftable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5909</span>	<span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token number">5910</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>函數filestat，fileread，filewrite 實現了對檔的 stat，read，write 操作。</li>
<li>filestat只允許作用在 i 節點上，它通過調用 stati 實現。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5950</span>	<span class="token comment">// Get metadata about file f.</span>
<span class="token number">5951</span>	int
<span class="token number">5952</span>	<span class="token function">filestat</span><span class="token punctuation">(</span>struct file <span class="token operator">*</span>f<span class="token punctuation">,</span> struct stat <span class="token operator">*</span>st<span class="token punctuation">)</span>
<span class="token number">5953</span>	<span class="token punctuation">{</span>
<span class="token number">5954</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_INODE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5955</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5956</span>	<span class="token function">stati</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5957</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5958</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5959</span>	<span class="token punctuation">}</span>
<span class="token number">5960</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5961</span>	<span class="token punctuation">}</span>
<span class="token number">5962</span>	
<span class="token number">5963</span>	<span class="token comment">// Read from file f.</span>
<span class="token number">5964</span>	int
<span class="token number">5965</span>	<span class="token function">fileread</span><span class="token punctuation">(</span>struct file <span class="token operator">*</span>f<span class="token punctuation">,</span> char <span class="token operator">*</span>addr<span class="token punctuation">,</span> int n<span class="token punctuation">)</span>
<span class="token number">5966</span>	<span class="token punctuation">{</span>
<span class="token number">5967</span>	int r<span class="token punctuation">;</span>
<span class="token number">5968</span>	
<span class="token number">5969</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>readable <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5970</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5971</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_PIPE</span><span class="token punctuation">)</span>
<span class="token number">5972</span>	<span class="token keyword">return</span> <span class="token function">piperead</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>pipe<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5973</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_INODE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5974</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5975</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">readi</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> f−<span class="token operator">&gt;</span>off<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5976</span>	f−<span class="token operator">&gt;</span>off <span class="token operator">+=</span> r<span class="token punctuation">;</span>
<span class="token number">5977</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5978</span>	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token number">5979</span>	<span class="token punctuation">}</span>
<span class="token number">5980</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"fileread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5981</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>fileread 和 filewrite 檢查這個操作被檔的打開屬性所允許然後把執行讓渡給 i 節點的實現或者管道的實現。如果這個檔代表的是一個 i 節點，fileread和 filewrite 就會把 i/o 偏移作為該操作的偏移並且往前移。管道沒有偏移這個概念，要調用者來處理鎖。i 節點鎖有一個方便的副作用那就是讀寫偏移會自動更新，所以同時對一個檔寫並不會覆蓋各自的檔，但是寫的順序是不被保證的，因此寫的結果可能是交錯的。</li>
</ul><pre><code class="javascript hljs"><span class="token number">5963</span>	<span class="token comment">// Read from file f.</span>
<span class="token number">5964</span>	int
<span class="token number">5965</span>	<span class="token function">fileread</span><span class="token punctuation">(</span>struct file <span class="token operator">*</span>f<span class="token punctuation">,</span> char <span class="token operator">*</span>addr<span class="token punctuation">,</span> int n<span class="token punctuation">)</span>
<span class="token number">5966</span>	<span class="token punctuation">{</span>
<span class="token number">5967</span>	int r<span class="token punctuation">;</span>
<span class="token number">5968</span>	
<span class="token number">5969</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>readable <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5970</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">5971</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_PIPE</span><span class="token punctuation">)</span>
<span class="token number">5972</span>	<span class="token keyword">return</span> <span class="token function">piperead</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>pipe<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5973</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_INODE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">5974</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5975</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">readi</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> f−<span class="token operator">&gt;</span>off<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">5976</span>	f−<span class="token operator">&gt;</span>off <span class="token operator">+=</span> r<span class="token punctuation">;</span>
<span class="token number">5977</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5978</span>	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token number">5979</span>	<span class="token punctuation">}</span>
<span class="token number">5980</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"fileread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5981</span>	<span class="token punctuation">}</span>
<span class="token number">6000</span>	<span class="token comment">// Write to file f.</span>
<span class="token number">6001</span>	int
<span class="token number">6002</span>	<span class="token function">filewrite</span><span class="token punctuation">(</span>struct file <span class="token operator">*</span>f<span class="token punctuation">,</span> char <span class="token operator">*</span>addr<span class="token punctuation">,</span> int n<span class="token punctuation">)</span>
<span class="token number">6003</span>	<span class="token punctuation">{</span>
<span class="token number">6004</span>	int r<span class="token punctuation">;</span>
<span class="token number">6005</span>	
<span class="token number">6006</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>writable <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6007</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6008</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_PIPE</span><span class="token punctuation">)</span>
<span class="token number">6009</span>	<span class="token keyword">return</span> <span class="token function">pipewrite</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>pipe<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6010</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">FD_INODE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6011</span>	<span class="token comment">// write a few blocks at a time to avoid exceeding</span>
<span class="token number">6012</span>	<span class="token comment">// the maximum log transaction size, including</span>
<span class="token number">6013</span>	<span class="token comment">// i−node, indirect block, allocation blocks,</span>
<span class="token number">6014</span>	<span class="token comment">// and 2 blocks of slop for non−aligned writes.</span>
<span class="token number">6015</span>	<span class="token comment">// this really belongs lower down, since writei()</span>
<span class="token number">6016</span>	<span class="token comment">// might be writing a device like the console.</span>
<span class="token number">6017</span>	int max <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">LOGSIZE</span>−<span class="token number">1</span>−<span class="token number">1</span>−<span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">512</span><span class="token punctuation">;</span>
<span class="token number">6018</span>	int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6019</span>	<span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6020</span>	int n1 <span class="token operator">=</span> n − i<span class="token punctuation">;</span>
<span class="token number">6021</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>n1 <span class="token operator">&gt;</span> max<span class="token punctuation">)</span>
<span class="token number">6022</span>	n1 <span class="token operator">=</span> max<span class="token punctuation">;</span>
<span class="token number">6023</span>	
<span class="token number">6024</span>	<span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6025</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6026</span>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">writei</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">,</span> addr <span class="token operator">+</span> i<span class="token punctuation">,</span> f−<span class="token operator">&gt;</span>off<span class="token punctuation">,</span> n1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6027</span>	f−<span class="token operator">&gt;</span>off <span class="token operator">+=</span> r<span class="token punctuation">;</span>
<span class="token number">6028</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>f−<span class="token operator">&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6029</span>	<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6030</span>	
<span class="token number">6031</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6032</span>	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">6033</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">!=</span> n1<span class="token punctuation">)</span>
<span class="token number">6034</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"short filewrite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6035</span>	i <span class="token operator">+=</span> r<span class="token punctuation">;</span>
<span class="token number">6036</span>	<span class="token punctuation">}</span>
<span class="token number">6037</span>	<span class="token keyword">return</span> i <span class="token operator">==</span> n <span class="token operator">?</span> n <span class="token punctuation">:</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6038</span>	<span class="token punctuation">}</span>
<span class="token number">6039</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"filewrite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6040</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>接下來闡釋系統調用。函數 sys_link 和sys_unlink 修改目錄檔，可能會創建或者移除對 i 節點的引用。</li>
<li>sys_link 為一個已有的 i 節點創建一個新的名字。sys_link最開始獲取自己的參數 old 和 new 兩個字串。假設 old 是存在的並且不是一個目錄檔。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6200</span>	<span class="token comment">// Create the path new as a link to the same inode as old.</span>
<span class="token number">6201</span>	int
<span class="token number">6202</span>	<span class="token function">sys_link</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">6203</span>	<span class="token punctuation">{</span>
<span class="token number">6204</span>	char name<span class="token punctuation">[</span><span class="token constant">DIRSIZ</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
<span class="token number">6205</span>	struct inode <span class="token operator">*</span>dp<span class="token punctuation">,</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>
</code></pre><ul>
<li>sys_link 增加它的 ip-&gt;nlink 計數。然後 sys_link 調用 nameiparent(new)來尋找上級目錄和最終的目錄元素。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6207</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>old<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">new</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6208</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>最後創建一個目錄項指向old的 i 節點。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6210</span>	<span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6211</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6212</span>	<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6213</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6214</span>	<span class="token punctuation">}</span>
<span class="token number">6215</span>	
<span class="token number">6216</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6217</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">T_DIR</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6218</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6219</span>	<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6220</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6221</span>	<span class="token punctuation">}</span>
<span class="token number">6222</span>	
<span class="token number">6223</span>	ip−<span class="token operator">&gt;</span>nlink<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">6224</span>	<span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6225</span>	<span class="token function">iunlock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6226</span>	
<span class="token number">6227</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dp <span class="token operator">=</span> <span class="token function">nameiparent</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6228</span>	goto bad<span class="token punctuation">;</span>
<span class="token number">6229</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>new 的上級目錄必須和已有 old 的 i 節點在同一個設備上；i 節點號只在同一個磁片上有意義。如果這樣的錯誤發生了，sys_link必須回溯並且還原引用計數。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6230</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>dp−<span class="token operator">&gt;</span>dev <span class="token operator">!=</span> ip−<span class="token operator">&gt;</span>dev <span class="token operator">||</span> <span class="token function">dirlink</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> name<span class="token punctuation">,</span> ip−<span class="token operator">&gt;</span>inum<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6231</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6232</span>	goto bad<span class="token punctuation">;</span>
<span class="token number">6233</span>	<span class="token punctuation">}</span>
<span class="token number">6234</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6235</span>	<span class="token function">iput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6236</span>	
<span class="token number">6237</span>	<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6238</span>	
<span class="token number">6239</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6241</span>	bad<span class="token punctuation">:</span>
<span class="token number">6242</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6243</span>	ip−<span class="token operator">&gt;</span>nlink−−<span class="token punctuation">;</span>
<span class="token number">6244</span>	<span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6245</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6246</span>	<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6247</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6248</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>函數 create為一個新的 i 節點創建新名字。它是三個檔創建系統調用的綜合：用 O_CREATE 方式 open一個檔創建一個新的普通檔，mkdir 創建一個新的目錄檔，mkdev 創建一個新的設備檔。create，正如 sys_link 一樣，同時擁有兩個 i 節點鎖：ip 和 dp 。這不可能導致鎖死，因為 i 節點 ip 是剛被分配的：系統中沒有其他進程會持有 ip 的鎖並且嘗試鎖 dp。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6356</span>	<span class="token keyword">static</span> struct inode<span class="token operator">*</span>
<span class="token number">6357</span>	<span class="token function">create</span><span class="token punctuation">(</span>char <span class="token operator">*</span>path<span class="token punctuation">,</span> short type<span class="token punctuation">,</span> short major<span class="token punctuation">,</span> short minor<span class="token punctuation">)</span>
<span class="token number">6358</span>	<span class="token punctuation">{</span>
<span class="token number">6359</span>	uint off<span class="token punctuation">;</span>
<span class="token number">6360</span>	struct inode <span class="token operator">*</span>ip<span class="token punctuation">,</span> <span class="token operator">*</span>dp<span class="token punctuation">;</span>
<span class="token number">6361</span>	char name<span class="token punctuation">[</span><span class="token constant">DIRSIZ</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>就像sys_link一樣，create 調用 nameiparent 獲取上級目錄的 i 節點。然後調用 dirlookup 來檢查同名檔是否已經存在。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6363</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dp <span class="token operator">=</span> <span class="token function">nameiparent</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6364</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6365</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6366</span>	
<span class="token number">6367</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">dirlookup</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>off<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6368</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6369</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6370</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token constant">T_FILE</span> <span class="token operator">&amp;&amp;</span> ip−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">T_FILE</span><span class="token punctuation">)</span>
<span class="token number">6371</span>	<span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token number">6372</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6373</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6374</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>如果的確存在，create的行為就由它服務的系統調用所決定，open 和 mkdir 以及 mkdev 的語義是不同的。 如果是 open（type==T_FILE）調用的 create 並且按指定檔案名找到的檔是一個普通檔，那麼就認為打開成功，因此 create 中也認為是成功。在其他情況下，這就是一個錯誤。如果檔案名並不存在，create 就會用 ialloc分配一個新的 i 節點。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6376</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">ialloc</span><span class="token punctuation">(</span>dp−<span class="token operator">&gt;</span>dev<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6377</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"create: ialloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>如果新的 i 節點是一個目錄，create 就會初始化兩個目錄項。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6379</span>	<span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6380</span>	ip−<span class="token operator">&gt;</span>major <span class="token operator">=</span> major<span class="token punctuation">;</span>
<span class="token number">6381</span>	ip−<span class="token operator">&gt;</span>minor <span class="token operator">=</span> minor<span class="token punctuation">;</span>
<span class="token number">6382</span>	ip−<span class="token operator">&gt;</span>nlink <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6383</span>	<span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6384</span>	
<span class="token number">6385</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token constant">T_DIR</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// Create . and .. entries.</span>
<span class="token number">6386</span>	dp−<span class="token operator">&gt;</span>nlink<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// for ".."</span>
<span class="token number">6387</span>	<span class="token function">iupdate</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6388</span>	<span class="token comment">// No ip−&gt;nlink++ for ".": avoid cyclic ref count.</span>
</code></pre><ul>
<li>最後所有的資料都初始化妥當了，create 就可以把它連接到它的上級目錄。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6389</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">dirlink</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">,</span> ip−<span class="token operator">&gt;</span>inum<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">dirlink</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> dp−<span class="token operator">&gt;</span>inum<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6390</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"create dots"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6391</span>	<span class="token punctuation">}</span>
<span class="token number">6392</span>	
<span class="token number">6393</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">dirlink</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> name<span class="token punctuation">,</span> ip−<span class="token operator">&gt;</span>inum<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6394</span>	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"create: dirlink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6395</span>	
<span class="token number">6396</span>	<span class="token function">iunlockput</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6397</span>	
<span class="token number">6398</span>	<span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token number">6399</span>	<span class="token punctuation">}</span>
</code></pre><ul>
<li>sys_open ：sys_open 分配了一個檔和檔描述符，接著填充了這個檔。如果 open 以 O_CREATE 調用，它就會調用 create，否則，它就會調用 namei。</li>
<li>create 會返回一個帶鎖的 i 節點，但是 namei 並不會，所以 sys_open 必須要自己鎖上這個 i 節點。這樣提供了一個合適的地方來檢查目錄只被打開用於讀，而不是寫。總之我們獲得了一個 i 節點（不管是用 create 還是用 namei)。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6400</span>	int	
<span class="token number">6401</span>	<span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	
<span class="token number">6402</span>	<span class="token punctuation">{</span>	
<span class="token number">6403</span>	char <span class="token operator">*</span>path<span class="token punctuation">;</span>	
<span class="token number">6404</span>	int fd<span class="token punctuation">,</span> omode<span class="token punctuation">;</span>	
<span class="token number">6405</span>	struct file <span class="token operator">*</span>f<span class="token punctuation">;</span>	
<span class="token number">6406</span>	struct inode <span class="token operator">*</span>ip<span class="token punctuation">;</span>	
<span class="token number">6407</span>		
<span class="token number">6408</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>path<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>	<span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>omode<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6409</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>	
<span class="token number">6410</span> <span class="token number">6460</span>
<span class="token number">6411</span>		<span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6412</span>		
<span class="token number">6413</span>		<span class="token keyword">if</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> <span class="token constant">O_CREATE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6414</span>		ip <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token constant">T_FILE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6415</span>		<span class="token keyword">if</span><span class="token punctuation">(</span>ip <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6416</span>		<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6417</span>		<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6418</span>		<span class="token punctuation">}</span>
<span class="token number">6419</span>		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">6420</span>		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6421</span>		<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6422</span>		<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6423</span>		<span class="token punctuation">}</span>
<span class="token number">6424</span>		<span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6425</span>		<span class="token keyword">if</span><span class="token punctuation">(</span>ip−<span class="token operator">&gt;</span>type <span class="token operator">==</span> <span class="token constant">T_DIR</span> <span class="token operator">&amp;&amp;</span> omode <span class="token operator">!=</span> <span class="token constant">O_RDONLY</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6426</span>		<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6427</span>		<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6428</span>		<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6429</span>		<span class="token punctuation">}</span>
<span class="token number">6430</span>		<span class="token punctuation">}</span>
<span class="token number">6431</span>		
<span class="token number">6432</span>		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">filealloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">fdalloc</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6433</span>		<span class="token keyword">if</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token number">6434</span>		<span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6435</span>		<span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6436</span>		<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6437</span>		<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6438</span>		<span class="token punctuation">}</span>
<span class="token number">6439</span>		<span class="token function">iunlock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6440</span>		<span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6441</span>		
<span class="token number">6442</span>		f−<span class="token operator">&gt;</span>type <span class="token operator">=</span> <span class="token constant">FD_INODE</span><span class="token punctuation">;</span>
<span class="token number">6443</span>		f−<span class="token operator">&gt;</span>ip <span class="token operator">=</span> ip<span class="token punctuation">;</span>
<span class="token number">6444</span>		f−<span class="token operator">&gt;</span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6445</span>		f−<span class="token operator">&gt;</span>readable <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> <span class="token constant">O_WRONLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6446</span>		f−<span class="token operator">&gt;</span>writable <span class="token operator">=</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> <span class="token constant">O_WRONLY</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> <span class="token constant">O_RDWR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6447</span>		<span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token number">6448</span>	<span class="token punctuation">}</span>	
</code></pre><ul>
<li>函數 sys_pipe 通過管道對的方式把管道的實現和檔案系統連接來。它的參數是一個指向可裝入兩個整數的陣列指標，這個陣列將用於記錄兩個新的檔描述符。然後它分配管道，將新的檔描述符存入這個陣列中。</li>
</ul><pre><code class="javascript hljs"><span class="token number">6550</span>	int
<span class="token number">6551</span>	<span class="token function">sys_pipe</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">6552</span>	<span class="token punctuation">{</span>
<span class="token number">6553</span>	int <span class="token operator">*</span>fd<span class="token punctuation">;</span>
<span class="token number">6554</span>	struct file <span class="token operator">*</span>rf<span class="token punctuation">,</span> <span class="token operator">*</span>wf<span class="token punctuation">;</span>
<span class="token number">6555</span>	int fd0<span class="token punctuation">,</span> fd1<span class="token punctuation">;</span>
<span class="token number">6556</span>	
<span class="token number">6557</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">argptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span><span class="token function">sizeof</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6558</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6559</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pipealloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6560</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6561</span>	fd0 <span class="token operator">=</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6562</span>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd0 <span class="token operator">=</span> <span class="token function">fdalloc</span><span class="token punctuation">(</span>rf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fd1 <span class="token operator">=</span> <span class="token function">fdalloc</span><span class="token punctuation">(</span>wf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token number">6563</span>	<span class="token keyword">if</span><span class="token punctuation">(</span>fd0 <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">6564</span>	<span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>−<span class="token operator">&gt;</span>ofile<span class="token punctuation">[</span>fd0<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6565</span>	<span class="token function">fileclose</span><span class="token punctuation">(</span>rf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6566</span>	<span class="token function">fileclose</span><span class="token punctuation">(</span>wf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6567</span>	<span class="token keyword">return</span> −<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">6568</span>	<span class="token punctuation">}</span>
<span class="token number">6569</span>	fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> fd0<span class="token punctuation">;</span>
<span class="token number">6570</span>	fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fd1<span class="token punctuation">;</span>
<span class="token number">6571</span>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">6572</span>	<span class="token punctuation">}</span>
</code></pre><h4 id="程式流程"><a class="anchor hidden-xs" href="#程式流程" title="程式流程"><span class="octicon octicon-link"></span></a>程式流程</h4><p><img src="https://i.imgur.com/hp1x5xi.png" alt=""></p><p><img src="https://i.imgur.com/wofwB6a.png" alt=""></p><p><img src="https://i.imgur.com/sBBMMbX.png" alt=""></p><p><img src="https://i.imgur.com/K44brJW.png" alt=""></p><p><img src="https://i.imgur.com/yg9dUnp.png" alt=""></p><p><img src="https://i.imgur.com/aepq9VD.png" alt=""></p><p><img src="https://i.imgur.com/9fZcLnH.png" alt=""></p><p><img src="https://i.imgur.com/RL5tXlN.png" alt=""></p><p><img src="https://i.imgur.com/7wCno3S.png" alt=""></p><p><img src="https://i.imgur.com/AshkCXQ.png" alt=""></p><p><img src="https://i.imgur.com/vcA6bMf.png" alt=""></p><p><img src="https://i.imgur.com/yyDgxXa.png" alt=""></p><p><img src="https://i.imgur.com/UK8uqJ1.png" alt=""></p><h3 id="現實情況"><a class="anchor hidden-xs" href="#現實情況" title="現實情況"><span class="octicon octicon-link"></span></a>現實情況</h3><p>現實情況中作業系統的塊緩衝比xv6中要複雜的多，但依舊為兩個主要目的服務：緩衝和同步到磁片。一種更有效的LRU緩衝策略會減少鏈表的使用，它將用雜湊表來實現查找、用堆來實現LRU的回收。現代塊緩衝一般會結合虛擬記憶體系統從而可以支援映射到記憶體的檔。微軟Windows的NTFS，Mac OS X的HFS，以及Solaris的ZFS,這些檔案系統，僅僅命名了一些目錄，把目錄實現為磁片上塊的平衡樹結構。這樣雖然複雜，但保證了log級別時間複雜度的查找。現代的UNIX系統有很多方式：管道，網路連接，和許多來自不同類型檔案系統的 i 節點，包括網路檔案系統。</p></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc expand"><ul class="nav"><li class=""><a href="#HW1" title="HW1">HW1</a><ul class="nav"><li class=""><a href="#項目一：" title="項目一：">項目一：</a><ul class="nav"><li class=""><a href="#此時暫存器的值" title="此時暫存器的值">此時暫存器的值</a></li><li><a href="#STACK" title="STACK">STACK</a></li></ul></li><li><a href="#項目二：" title="項目二：">項目二：</a><ul class="nav"><li><a href="#第0章" title="第0章">第0章</a></li><li><a href="#第1章" title="第1章">第1章</a></li></ul></li><li class=""><a href="#項目三：" title="項目三：">項目三：</a><ul class="nav"><li><a href="#概述" title="概述">概述</a></li><li><a href="#Buffer-cache" title="Buffer cache">Buffer cache</a></li><li><a href="#Logging" title="Logging">Logging</a></li><li><a href="#Inodes-and-block-allocator" title="Inodes and block allocator">Inodes and block allocator</a></li><li><a href="#Directories（Directory-inodes）" title="Directories（Directory inodes）">Directories（Directory inodes）</a></li><li><a href="#Pathnames（Recursive-lookup）" title="Pathnames（Recursive lookup）">Pathnames（Recursive lookup）</a></li><li class=""><a href="#System-calls（File-descriptors）" title="System calls（File descriptors）">System calls（File descriptors）</a></li><li><a href="#現實情況" title="現實情況">現實情況</a></li></ul></li></ul></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Collapse all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;"  >
        <div class="toc expand"><ul class="nav"><li class=""><a href="#HW1" title="HW1">HW1</a><ul class="nav"><li class=""><a href="#項目一：" title="項目一：">項目一：</a><ul class="nav"><li class=""><a href="#此時暫存器的值" title="此時暫存器的值">此時暫存器的值</a></li><li><a href="#STACK" title="STACK">STACK</a></li></ul></li><li><a href="#項目二：" title="項目二：">項目二：</a><ul class="nav"><li><a href="#第0章" title="第0章">第0章</a></li><li><a href="#第1章" title="第1章">第1章</a></li></ul></li><li class=""><a href="#項目三：" title="項目三：">項目三：</a><ul class="nav"><li><a href="#概述" title="概述">概述</a></li><li><a href="#Buffer-cache" title="Buffer cache">Buffer cache</a></li><li><a href="#Logging" title="Logging">Logging</a></li><li><a href="#Inodes-and-block-allocator" title="Inodes and block allocator">Inodes and block allocator</a></li><li><a href="#Directories（Directory-inodes）" title="Directories（Directory inodes）">Directories（Directory inodes）</a></li><li><a href="#Pathnames（Recursive-lookup）" title="Pathnames（Recursive lookup）">Pathnames（Recursive lookup）</a></li><li class=""><a href="#System-calls（File-descriptors）" title="System calls（File descriptors）">System calls（File descriptors）</a></li><li><a href="#現實情況" title="現實情況">現實情況</a></li></ul></li></ul></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
